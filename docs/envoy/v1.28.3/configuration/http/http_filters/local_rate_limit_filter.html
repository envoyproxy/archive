<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Local rate limit &mdash; envoy tag-v1.28.3 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d7d10ef0" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/envoy.css?v=3ec0219e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=a5c4661c" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=4cda4859"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../_static/copybutton.js?v=db7b0edf"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Lua" href="lua_filter.html" />
    <link rel="prev" title="Language" href="language_filter.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                tag-v1.28.3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../listeners/listeners.html">Listeners</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../http.html">HTTP</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../http_conn_man/http_conn_man.html">HTTP connection manager</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="http_filters.html">HTTP filters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="adaptive_concurrency_filter.html">Adaptive Concurrency</a></li>
<li class="toctree-l4"><a class="reference internal" href="admission_control_filter.html">Admission Control</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_lambda_filter.html">AWS Lambda</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_request_signing_filter.html">AWS Request Signing</a></li>
<li class="toctree-l4"><a class="reference internal" href="bandwidth_limit_filter.html">Bandwidth limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="buffer_filter.html">Buffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="cache_filter.html">Cache filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="cdn_loop_filter.html">CDN-Loop header</a></li>
<li class="toctree-l4"><a class="reference internal" href="checksum_filter.html">Checksum</a></li>
<li class="toctree-l4"><a class="reference internal" href="compressor_filter.html">Compressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="composite_filter.html">Composite Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="connect_grpc_bridge_filter.html">Connect-gRPC Bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="cors_filter.html">CORS</a></li>
<li class="toctree-l4"><a class="reference internal" href="csrf_filter.html">CSRF</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom_response_filter.html">Custom Response Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="decompressor_filter.html">Decompressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic_forward_proxy_filter.html">Dynamic forward proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamodb_filter.html">DynamoDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_proc_filter.html">External Processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="fault_filter.html">Fault Injection</a></li>
<li class="toctree-l4"><a class="reference internal" href="file_system_buffer_filter.html">File System Buffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="gcp_authn_filter.html">GCP Authentication Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="geoip_filter.html">IP Geolocation Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="golang_filter.html">Golang</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_field_extraction_filter.html">gRPC Field Extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_bridge_filter.html">gRPC HTTP/1.1 bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_reverse_bridge_filter.html">gRPC HTTP/1.1 reverse bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_json_transcoder_filter.html">gRPC-JSON transcoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_stats_filter.html">gRPC Statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_web_filter.html">gRPC-Web</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_mutation_filter.html">Header Mutation</a></li>
<li class="toctree-l4"><a class="reference internal" href="health_check_filter.html">Health check</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_to_metadata_filter.html">Envoy Header-To-Metadata Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="ip_tagging_filter.html">IP Tagging</a></li>
<li class="toctree-l4"><a class="reference internal" href="json_to_metadata_filter.html">Envoy Json-To-Metadata Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="jwt_authn_filter.html">JWT Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="kill_request_filter.html">Kill Request</a></li>
<li class="toctree-l4"><a class="reference internal" href="language_filter.html">Language</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Local rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="lua_filter.html">Lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="oauth2_filter.html">OAuth2</a></li>
<li class="toctree-l4"><a class="reference internal" href="on_demand_updates_filter.html">On-demand VHDS, S/RDS and CDS Updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="original_src_filter.html">Original Source</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_filter.html">Rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_quota_filter.html">Rate Limit Quota (Work-In-Progress)</a></li>
<li class="toctree-l4"><a class="reference internal" href="rbac_filter.html">Role Based Access Control (RBAC) Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="router_filter.html">Router</a></li>
<li class="toctree-l4"><a class="reference internal" href="set_filter_state.html">Set-Filter-State HTTP Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="set_metadata_filter.html">Set Metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="squash_filter.html">Squash</a></li>
<li class="toctree-l4"><a class="reference internal" href="stateful_session_filter.html">Stateful session</a></li>
<li class="toctree-l4"><a class="reference internal" href="sxg_filter.html">SXG</a></li>
<li class="toctree-l4"><a class="reference internal" href="tap_filter.html">Tap</a></li>
<li class="toctree-l4"><a class="reference internal" href="upstream_codec_filter.html">Upstream Codec</a></li>
<li class="toctree-l4"><a class="reference internal" href="wasm_filter.html">Wasm</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../caches/caches.html">HTTP caches</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cluster_specifier/cluster_specifier.html">HTTP cluster specifier</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../configuration.html">Configuration reference</a></li>
          <li class="breadcrumb-item"><a href="../http.html">HTTP</a></li>
          <li class="breadcrumb-item"><a href="http_filters.html">HTTP filters</a></li>
      <li class="breadcrumb-item active">Local rate limit</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/configuration/http/http_filters/local_rate_limit_filter.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="local-rate-limit">
<span id="config-http-filters-local-rate-limit"></span><h1>Local rate limit<a class="headerlink" href="#local-rate-limit" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p>Local rate limiting <a class="reference internal" href="../../../intro/arch_overview/other_features/local_rate_limiting.html#arch-overview-local-rate-limit"><span class="std std-ref">architecture overview</span></a></p></li>
<li><p>This filter should be configured with the type URL <code class="docutils literal notranslate"><span class="pre">type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit</span></code>.</p></li>
<li><p><a class="reference internal" href="../../../api-v3/extensions/filters/http/local_ratelimit/v3/local_rate_limit.proto.html#envoy-v3-api-msg-extensions-filters-http-local-ratelimit-v3-localratelimit"><span class="std std-ref">v3 API reference</span></a></p></li>
</ul>
<p>The HTTP local rate limit filter applies a <a class="reference internal" href="../../../api-v3/extensions/filters/http/local_ratelimit/v3/local_rate_limit.proto.html#envoy-v3-api-field-extensions-filters-http-local-ratelimit-v3-localratelimit-token-bucket"><span class="std std-ref">token bucket</span></a> rate
limit when the request’s route or virtual host has a per filter
<a class="reference internal" href="../../../api-v3/extensions/filters/http/local_ratelimit/v3/local_rate_limit.proto.html#envoy-v3-api-msg-extensions-filters-http-local-ratelimit-v3-localratelimit"><span class="std std-ref">local rate limit configuration</span></a>.</p>
<p>If the local rate limit token bucket is checked, and there are no tokens available, a 429 response is returned
(the response is configurable). The local rate limit filter then sets the
<a class="reference internal" href="router_filter.html#config-http-filters-router-x-envoy-ratelimited"><span class="std std-ref">x-envoy-ratelimited</span></a> response header. <a class="reference internal" href="../../../api-v3/extensions/filters/http/local_ratelimit/v3/local_rate_limit.proto.html#envoy-v3-api-field-extensions-filters-http-local-ratelimit-v3-localratelimit-response-headers-to-add"><span class="std std-ref">Additional response headers</span></a> can be
configured to be returned.</p>
<p><a class="reference internal" href="../../../api-v3/extensions/filters/http/local_ratelimit/v3/local_rate_limit.proto.html#envoy-v3-api-field-extensions-filters-http-local-ratelimit-v3-localratelimit-request-headers-to-add-when-not-enforced"><span class="std std-ref">Request headers</span></a> can be
configured to be added to forwarded requests to the upstream when the local rate limit filter is enabled but not enforced.</p>
<p>Depending on the value of the config <a class="reference internal" href="../../../api-v3/extensions/filters/http/local_ratelimit/v3/local_rate_limit.proto.html#envoy-v3-api-field-extensions-filters-http-local-ratelimit-v3-localratelimit-local-rate-limit-per-downstream-connection"><span class="std std-ref">local_rate_limit_per_downstream_connection</span></a>,
the token bucket is either shared across all workers or on a per connection basis. This results in the local rate limits being applied either per Envoy process or per downstream connection.
By default the rate limits are applied per Envoy process.</p>
<section id="example-configuration">
<h2>Example configuration<a class="headerlink" href="#example-configuration" title="Link to this heading"></a></h2>
<p>Example filter configuration for a globally set rate limiter (e.g.: all vhosts/routes share the same token bucket):</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/0e039036f53cb78357a657f1cf05a026/local-rate-limit-global-configuration.yaml"><code class="xref download docutils literal notranslate"><span class="pre">local-rate-limit-global-configuration.yaml</span></code></a></span><a class="headerlink" href="#id1" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">13</span><span class="w">          </span><span class="nt">http_filters</span><span class="p">:</span>
<span class="linenos">14</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.local_ratelimit</span>
<span class="linenos">15</span><span class="w">            </span><span class="nt">typed_config</span><span class="p">:</span>
<span class="linenos">16</span><span class="w">              </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit</span>
<span class="linenos">17</span><span class="w">              </span><span class="nt">stat_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http_local_rate_limiter</span>
<span class="linenos">18</span><span class="w">              </span><span class="nt">token_bucket</span><span class="p">:</span>
<span class="linenos">19</span><span class="w">                </span><span class="nt">max_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="linenos">20</span><span class="w">                </span><span class="nt">tokens_per_fill</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="linenos">21</span><span class="w">                </span><span class="nt">fill_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1s</span>
<span class="linenos">22</span><span class="w">              </span><span class="nt">filter_enabled</span><span class="p">:</span>
<span class="linenos">23</span><span class="w">                </span><span class="nt">runtime_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local_rate_limit_enabled</span>
<span class="linenos">24</span><span class="w">                </span><span class="nt">default_value</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">                  </span><span class="nt">numerator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="linenos">26</span><span class="w">                  </span><span class="nt">denominator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HUNDRED</span>
<span class="linenos">27</span><span class="w">              </span><span class="nt">filter_enforced</span><span class="p">:</span>
<span class="linenos">28</span><span class="w">                </span><span class="nt">runtime_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local_rate_limit_enforced</span>
<span class="linenos">29</span><span class="w">                </span><span class="nt">default_value</span><span class="p">:</span>
<span class="linenos">30</span><span class="w">                  </span><span class="nt">numerator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="linenos">31</span><span class="w">                  </span><span class="nt">denominator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HUNDRED</span>
<span class="linenos">32</span><span class="w">              </span><span class="nt">response_headers_to_add</span><span class="p">:</span>
<span class="linenos">33</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">append_action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OVERWRITE_IF_EXISTS_OR_ADD</span>
<span class="linenos">34</span><span class="w">                </span><span class="nt">header</span><span class="p">:</span>
<span class="linenos">35</span><span class="w">                  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">x-local-rate-limit</span>
<span class="linenos">36</span><span class="w">                  </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;true&#39;</span>
<span class="linenos">37</span><span class="w">              </span><span class="nt">local_rate_limit_per_downstream_connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
</div>
<p>Example filter configuration for a globally disabled rate limiter but enabled for a specific route:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/1f38d20a31590590dae5758871b7dd1b/local-rate-limit-route-specific-configuration.yaml"><code class="xref download docutils literal notranslate"><span class="pre">local-rate-limit-route-specific-configuration.yaml</span></code></a></span><a class="headerlink" href="#id2" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">13</span><span class="w">          </span><span class="nt">http_filters</span><span class="p">:</span>
<span class="linenos">14</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.local_ratelimit</span>
<span class="linenos">15</span><span class="w">            </span><span class="nt">typed_config</span><span class="p">:</span>
<span class="linenos">16</span><span class="w">              </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit</span>
<span class="linenos">17</span><span class="w">              </span><span class="nt">stat_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http_local_rate_limiter</span>
</pre></div>
</div>
</div>
<p>The route specific configuration:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/1f38d20a31590590dae5758871b7dd1b/local-rate-limit-route-specific-configuration.yaml"><code class="xref download docutils literal notranslate"><span class="pre">local-rate-limit-route-specific-configuration.yaml</span></code></a></span><a class="headerlink" href="#id3" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">21</span><span class="w">          </span><span class="nt">route_config</span><span class="p">:</span>
<span class="linenos">22</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local_route</span>
<span class="linenos">23</span><span class="w">            </span><span class="nt">virtual_hosts</span><span class="p">:</span>
<span class="linenos">24</span><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local_service</span>
<span class="linenos">25</span><span class="w">              </span><span class="nt">domains</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;*&quot;</span><span class="p p-Indicator">]</span>
<span class="linenos">26</span><span class="w">              </span><span class="nt">routes</span><span class="p">:</span>
<span class="linenos">27</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/path/with/rate/limit&quot;</span><span class="p p-Indicator">}</span>
<span class="linenos">28</span><span class="w">                </span><span class="nt">route</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="nv">service_protected_by_rate_limit</span><span class="p p-Indicator">}</span>
<span class="linenos">29</span><span class="w">                </span><span class="nt">typed_per_filter_config</span><span class="p">:</span>
<span class="linenos">30</span><span class="w">                  </span><span class="nt">envoy.filters.http.local_ratelimit</span><span class="p">:</span>
<span class="linenos">31</span><span class="w">                    </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit</span>
<span class="linenos">32</span><span class="w">                    </span><span class="nt">stat_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http_local_rate_limiter</span>
<span class="linenos">33</span><span class="w">                    </span><span class="nt">token_bucket</span><span class="p">:</span>
<span class="linenos">34</span><span class="w">                      </span><span class="nt">max_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="linenos">35</span><span class="w">                      </span><span class="nt">tokens_per_fill</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="linenos">36</span><span class="w">                      </span><span class="nt">fill_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1s</span>
<span class="linenos">37</span><span class="w">                    </span><span class="nt">filter_enabled</span><span class="p">:</span>
<span class="linenos">38</span><span class="w">                      </span><span class="nt">runtime_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local_rate_limit_enabled</span>
<span class="linenos">39</span><span class="w">                      </span><span class="nt">default_value</span><span class="p">:</span>
<span class="linenos">40</span><span class="w">                        </span><span class="nt">numerator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="linenos">41</span><span class="w">                        </span><span class="nt">denominator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HUNDRED</span>
<span class="linenos">42</span><span class="w">                    </span><span class="nt">filter_enforced</span><span class="p">:</span>
<span class="linenos">43</span><span class="w">                      </span><span class="nt">runtime_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local_rate_limit_enforced</span>
<span class="linenos">44</span><span class="w">                      </span><span class="nt">default_value</span><span class="p">:</span>
<span class="linenos">45</span><span class="w">                        </span><span class="nt">numerator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="linenos">46</span><span class="w">                        </span><span class="nt">denominator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HUNDRED</span>
<span class="linenos">47</span><span class="w">                    </span><span class="nt">response_headers_to_add</span><span class="p">:</span>
<span class="linenos">48</span><span class="w">                    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">append_action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OVERWRITE_IF_EXISTS_OR_ADD</span>
<span class="linenos">49</span><span class="w">                      </span><span class="nt">header</span><span class="p">:</span>
<span class="linenos">50</span><span class="w">                        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">x-local-rate-limit</span>
<span class="linenos">51</span><span class="w">                        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;true&#39;</span>
<span class="linenos">52</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p p-Indicator">}</span>
<span class="linenos">53</span><span class="w">                </span><span class="nt">route</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="nv">default_service</span><span class="p p-Indicator">}</span>
</pre></div>
</div>
</div>
<p>Note that if this filter is configured as globally disabled and there are no virtual host or route level
token buckets, no rate limiting will be applied.</p>
</section>
<section id="using-rate-limit-descriptors-for-local-rate-limiting">
<span id="config-http-filters-local-rate-limit-descriptors"></span><h2>Using rate limit descriptors for local rate limiting<a class="headerlink" href="#using-rate-limit-descriptors-for-local-rate-limiting" title="Link to this heading"></a></h2>
<p>Rate limit descriptors can be used to override local per-route rate limiting.
A route’s <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-msg-config-route-v3-ratelimit"><span class="std std-ref">rate limit action</span></a>
is used to match up a <a class="reference internal" href="../../../api-v3/extensions/common/ratelimit/v3/ratelimit.proto.html#envoy-v3-api-msg-extensions-common-ratelimit-v3-localratelimitdescriptor"><span class="std std-ref">local descriptor</span></a> in
the filter config descriptor list. The local descriptor’s token bucket
settings are then used to decide if the request should be rate limited or not
depending on whether the local descriptor’s entries match the route’s rate
limit actions descriptor entries. If there is no matching descriptor entries,
the default token bucket is used. All the matched local descriptors will be
sorterd by tokens per second and try to consume tokens in order, in most cases
if one of them is limited, the remaining descriptors will not consume their tokens.
However, in some cases, it may not work, for example, we have two descriptors
A and B, A is limited 3 requests per second, and B is limited 20 requests per 10 seconds.
Obviously B is stricter than A (token per second), as a result, if we send requests
above 3 in a second, the limited requests from A will also consume tokens of B.
Note that global tokens are not sorted, so we suggest they should be larger than other descriptors.</p>
<p>Example filter configuration using descriptors:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/af6690a4e3618ec257a0459a93f877c8/local-rate-limit-with-descriptors.yaml"><code class="xref download docutils literal notranslate"><span class="pre">local-rate-limit-with-descriptors.yaml</span></code></a></span><a class="headerlink" href="#id4" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">21</span><span class="w">          </span><span class="nt">route_config</span><span class="p">:</span>
<span class="linenos">22</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local_route</span>
<span class="linenos">23</span><span class="w">            </span><span class="nt">virtual_hosts</span><span class="p">:</span>
<span class="linenos">24</span><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local_service</span>
<span class="linenos">25</span><span class="w">              </span><span class="nt">domains</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;*&quot;</span><span class="p p-Indicator">]</span>
<span class="linenos">26</span><span class="w">              </span><span class="nt">routes</span><span class="p">:</span>
<span class="linenos">27</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/foo&quot;</span><span class="p p-Indicator">}</span>
<span class="linenos">28</span><span class="w">                </span><span class="nt">route</span><span class="p">:</span>
<span class="linenos">29</span><span class="w">                  </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service_protected_by_rate_limit</span>
<span class="linenos">30</span><span class="w">                  </span><span class="nt">rate_limits</span><span class="p">:</span>
<span class="linenos">31</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">actions</span><span class="p">:</span><span class="w">  </span><span class="c1"># any actions in here</span>
<span class="linenos">32</span><span class="w">                    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">request_headers</span><span class="p">:</span>
<span class="linenos">33</span><span class="w">                        </span><span class="nt">header_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">x-envoy-downstream-service-cluster</span>
<span class="linenos">34</span><span class="w">                        </span><span class="nt">descriptor_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client_cluster</span>
<span class="linenos">35</span><span class="w">                    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">request_headers</span><span class="p">:</span>
<span class="linenos">36</span><span class="w">                        </span><span class="nt">header_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;:path&quot;</span>
<span class="linenos">37</span><span class="w">                        </span><span class="nt">descriptor_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path</span>
<span class="linenos">38</span><span class="w">                </span><span class="nt">typed_per_filter_config</span><span class="p">:</span>
<span class="linenos">39</span><span class="w">                  </span><span class="nt">envoy.filters.http.local_ratelimit</span><span class="p">:</span>
<span class="linenos">40</span><span class="w">                    </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit</span>
<span class="linenos">41</span><span class="w">                    </span><span class="nt">stat_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="linenos">42</span><span class="w">                    </span><span class="nt">token_bucket</span><span class="p">:</span>
<span class="linenos">43</span><span class="w">                      </span><span class="nt">max_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="linenos">44</span><span class="w">                      </span><span class="nt">tokens_per_fill</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="linenos">45</span><span class="w">                      </span><span class="nt">fill_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60s</span>
<span class="linenos">46</span><span class="w">                    </span><span class="nt">filter_enabled</span><span class="p">:</span>
<span class="linenos">47</span><span class="w">                      </span><span class="nt">runtime_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_enabled</span>
<span class="linenos">48</span><span class="w">                      </span><span class="nt">default_value</span><span class="p">:</span>
<span class="linenos">49</span><span class="w">                        </span><span class="nt">numerator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="linenos">50</span><span class="w">                        </span><span class="nt">denominator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HUNDRED</span>
<span class="linenos">51</span><span class="w">                    </span><span class="nt">filter_enforced</span><span class="p">:</span>
<span class="linenos">52</span><span class="w">                      </span><span class="nt">runtime_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_enforced</span>
<span class="linenos">53</span><span class="w">                      </span><span class="nt">default_value</span><span class="p">:</span>
<span class="linenos">54</span><span class="w">                        </span><span class="nt">numerator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="linenos">55</span><span class="w">                        </span><span class="nt">denominator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HUNDRED</span>
<span class="linenos">56</span><span class="w">                    </span><span class="nt">response_headers_to_add</span><span class="p">:</span>
<span class="linenos">57</span><span class="w">                    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">append_action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OVERWRITE_IF_EXISTS_OR_ADD</span>
<span class="linenos">58</span><span class="w">                      </span><span class="nt">header</span><span class="p">:</span>
<span class="linenos">59</span><span class="w">                        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">x-test-rate-limit</span>
<span class="linenos">60</span><span class="w">                        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;true&#39;</span>
<span class="linenos">61</span><span class="w">                    </span><span class="nt">descriptors</span><span class="p">:</span>
<span class="linenos">62</span><span class="w">                    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">entries</span><span class="p">:</span>
<span class="linenos">63</span><span class="w">                      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client_cluster</span>
<span class="linenos">64</span><span class="w">                        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo</span>
<span class="linenos">65</span><span class="w">                      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path</span>
<span class="linenos">66</span><span class="w">                        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/foo/bar</span>
<span class="linenos">67</span><span class="w">                      </span><span class="nt">token_bucket</span><span class="p">:</span>
<span class="linenos">68</span><span class="w">                        </span><span class="nt">max_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="linenos">69</span><span class="w">                        </span><span class="nt">tokens_per_fill</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="linenos">70</span><span class="w">                        </span><span class="nt">fill_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60s</span>
<span class="linenos">71</span><span class="w">                    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">entries</span><span class="p">:</span>
<span class="linenos">72</span><span class="w">                      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client_cluster</span>
<span class="linenos">73</span><span class="w">                        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo</span>
<span class="linenos">74</span><span class="w">                      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path</span>
<span class="linenos">75</span><span class="w">                        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/foo/bar2</span>
<span class="linenos">76</span><span class="w">                      </span><span class="nt">token_bucket</span><span class="p">:</span>
<span class="linenos">77</span><span class="w">                        </span><span class="nt">max_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="linenos">78</span><span class="w">                        </span><span class="nt">tokens_per_fill</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="linenos">79</span><span class="w">                        </span><span class="nt">fill_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60s</span>
<span class="linenos">80</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p p-Indicator">}</span>
<span class="linenos">81</span><span class="w">                </span><span class="nt">route</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="nv">default_service</span><span class="p p-Indicator">}</span>
</pre></div>
</div>
</div>
<p>In this example, requests are rate-limited for routes prefixed with “/foo” as follows.
If requests come from a downstream service cluster “foo” for “/foo/bar”
path, then 10 req/min are allowed. But if they come from a downstream service
cluster “foo” for “/foo/bar2” path, then 100 req/min are allowed. Otherwise,
1000 req/min are allowed.</p>
</section>
<section id="statistics">
<h2>Statistics<a class="headerlink" href="#statistics" title="Link to this heading"></a></h2>
<p>The local rate limit filter outputs statistics in the <code class="docutils literal notranslate"><span class="pre">&lt;stat_prefix&gt;.http_local_rate_limit.</span></code> namespace.
429 responses – or the configured status code – are emitted to the normal cluster <a class="reference internal" href="../../upstream/cluster_manager/cluster_stats.html#config-cluster-manager-cluster-stats-dynamic-http"><span class="std std-ref">dynamic HTTP statistics</span></a>.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25.0%" />
<col style="width: 25.0%" />
<col style="width: 50.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>enabled</p></td>
<td><p>Counter</p></td>
<td><p>Total number of requests for which the rate limiter was consulted</p></td>
</tr>
<tr class="row-odd"><td><p>ok</p></td>
<td><p>Counter</p></td>
<td><p>Total under limit responses from the token bucket</p></td>
</tr>
<tr class="row-even"><td><p>rate_limited</p></td>
<td><p>Counter</p></td>
<td><p>Total responses without an available token (but not necessarily enforced)</p></td>
</tr>
<tr class="row-odd"><td><p>enforced</p></td>
<td><p>Counter</p></td>
<td><p>Total number of requests for which rate limiting was applied (e.g.: 429 returned)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="runtime">
<span id="config-http-filters-local-rate-limit-runtime"></span><h2>Runtime<a class="headerlink" href="#runtime" title="Link to this heading"></a></h2>
<p>The HTTP rate limit filter supports the following runtime fractional settings:</p>
<dl class="simple">
<dt>http_filter_enabled</dt><dd><p>% of requests that will check the local rate limit decision, but not enforce, for a given <em>route_key</em> specified
in the <a class="reference internal" href="../../../api-v3/extensions/filters/http/local_ratelimit/v3/local_rate_limit.proto.html#envoy-v3-api-msg-extensions-filters-http-local-ratelimit-v3-localratelimit"><span class="std std-ref">local rate limit configuration</span></a>.
Defaults to 0.</p>
</dd>
<dt>http_filter_enforcing</dt><dd><p>% of requests that will enforce the local rate limit decision for a given <em>route_key</em> specified in the
<a class="reference internal" href="../../../api-v3/extensions/filters/http/local_ratelimit/v3/local_rate_limit.proto.html#envoy-v3-api-msg-extensions-filters-http-local-ratelimit-v3-localratelimit"><span class="std std-ref">local rate limit configuration</span></a>.
Defaults to 0. This can be used to test what would happen before fully enforcing the outcome.</p>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="language_filter.html" class="btn btn-neutral float-left" title="Language" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="lua_filter.html" class="btn btn-neutral float-right" title="Lua" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2024, Envoy Project Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>