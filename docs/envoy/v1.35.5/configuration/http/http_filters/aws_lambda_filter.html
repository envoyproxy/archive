

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AWS Lambda &mdash; envoy tag-v1.35.5 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d7d10ef0" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/envoy.css?v=3ec0219e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=4da122e5" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=64545ba1"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=db7b0edf"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="API key auth" href="api_key_auth_filter.html" />
    <link rel="prev" title="Admission Control" href="admission_control_filter.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../listeners/listeners.html">Listeners</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../http.html">HTTP</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../http_conn_man/http_conn_man.html">HTTP connection manager</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="http_filters.html">HTTP filters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="adaptive_concurrency_filter.html">Adaptive Concurrency</a></li>
<li class="toctree-l4"><a class="reference internal" href="admission_control_filter.html">Admission Control</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">AWS Lambda</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_key_auth_filter.html">API key auth</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_request_signing_filter.html">AWS Request Signing</a></li>
<li class="toctree-l4"><a class="reference internal" href="bandwidth_limit_filter.html">Bandwidth limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="basic_auth_filter.html">Basic Auth</a></li>
<li class="toctree-l4"><a class="reference internal" href="buffer_filter.html">Buffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="cache_filter.html">Cache filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="cdn_loop_filter.html">CDN-Loop header</a></li>
<li class="toctree-l4"><a class="reference internal" href="checksum_filter.html">Checksum</a></li>
<li class="toctree-l4"><a class="reference internal" href="compressor_filter.html">Compressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="composite_filter.html">Composite Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="connect_grpc_bridge_filter.html">Connect-gRPC Bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="cors_filter.html">CORS</a></li>
<li class="toctree-l4"><a class="reference internal" href="credential_injector_filter.html">Credential injector</a></li>
<li class="toctree-l4"><a class="reference internal" href="csrf_filter.html">CSRF</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom_response_filter.html">Custom Response Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="decompressor_filter.html">Decompressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic_forward_proxy_filter.html">Dynamic forward proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamodb_filter.html">DynamoDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_proc_filter.html">External Processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="fault_filter.html">Fault Injection</a></li>
<li class="toctree-l4"><a class="reference internal" href="file_system_buffer_filter.html">File System Buffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="gcp_authn_filter.html">GCP Authentication Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="geoip_filter.html">IP Geolocation Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="golang_filter.html">Golang</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_field_extraction_filter.html">gRPC Field Extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_bridge_filter.html">gRPC HTTP/1.1 bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_reverse_bridge_filter.html">gRPC HTTP/1.1 reverse bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_json_reverse_transcoder_filter.html">gRPC-JSON reverse transcoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_json_transcoder_filter.html">gRPC-JSON transcoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_stats_filter.html">gRPC Statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_web_filter.html">gRPC-Web</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_mutation_filter.html">Header Mutation</a></li>
<li class="toctree-l4"><a class="reference internal" href="health_check_filter.html">Health check</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_to_metadata_filter.html">Envoy Header-To-Metadata Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="ip_tagging_filter.html">IP Tagging</a></li>
<li class="toctree-l4"><a class="reference internal" href="json_to_metadata_filter.html">Envoy Json-To-Metadata Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="jwt_authn_filter.html">JWT Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="kill_request_filter.html">Kill Request</a></li>
<li class="toctree-l4"><a class="reference internal" href="language_filter.html">Language</a></li>
<li class="toctree-l4"><a class="reference internal" href="local_rate_limit_filter.html">Local rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="lua_filter.html">Lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="oauth2_filter.html">OAuth2</a></li>
<li class="toctree-l4"><a class="reference internal" href="on_demand_updates_filter.html">On-demand VHDS, S/RDS and CDS Updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="original_src_filter.html">Original Source</a></li>
<li class="toctree-l4"><a class="reference internal" href="proto_message_extraction_filter.html">Proto Message Extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_filter.html">Rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_quota_filter.html">Rate Limit Quota (Work-In-Progress)</a></li>
<li class="toctree-l4"><a class="reference internal" href="rbac_filter.html">Role Based Access Control (RBAC) Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="router_filter.html">Router</a></li>
<li class="toctree-l4"><a class="reference internal" href="set_filter_state.html">Set-Filter-State HTTP Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="set_metadata_filter.html">Set Metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="stateful_session_filter.html">Stateful session</a></li>
<li class="toctree-l4"><a class="reference internal" href="sxg_filter.html">SXG</a></li>
<li class="toctree-l4"><a class="reference internal" href="tap_filter.html">Tap</a></li>
<li class="toctree-l4"><a class="reference internal" href="thrift_to_metadata_filter.html">Envoy Thrift-To-Metadata Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="upstream_codec_filter.html">Upstream Codec</a></li>
<li class="toctree-l4"><a class="reference internal" href="wasm_filter.html">Wasm</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../caches/caches.html">HTTP caches</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cluster_specifier/cluster_specifier.html">HTTP cluster specifier</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tcp_bridge/tcp_bridge.html">HTTP TCP bridge</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../configuration.html">Configuration reference</a></li>
          <li class="breadcrumb-item"><a href="../http.html">HTTP</a></li>
          <li class="breadcrumb-item"><a href="http_filters.html">HTTP filters</a></li>
      <li class="breadcrumb-item active">AWS Lambda</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/configuration/http/http_filters/aws_lambda_filter.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="aws-lambda">
<span id="config-http-filters-aws-lambda"></span><h1>AWS Lambda<a class="headerlink" href="#aws-lambda" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p>This filter should be configured with the type URL <code class="docutils literal notranslate"><span class="pre">type.googleapis.com/envoy.extensions.filters.http.aws_lambda.v3.Config</span></code>.</p></li>
<li><p><a class="reference internal" href="../../../api-v3/extensions/filters/http/aws_lambda/v3/aws_lambda.proto.html#envoy-v3-api-msg-extensions-filters-http-aws-lambda-v3-config"><span class="std std-ref">v3 API reference</span></a></p></li>
</ul>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The AWS Lambda filter is currently under active development.</p>
</div>
<p>The HTTP AWS Lambda filter is used to trigger an AWS Lambda function from a standard HTTP request.
It supports a few options to control whether to pass through the HTTP request payload as is or to wrap it in a JSON
schema.</p>
<p>If <a class="reference internal" href="../../../api-v3/extensions/filters/http/aws_lambda/v3/aws_lambda.proto.html#envoy-v3-api-field-extensions-filters-http-aws-lambda-v3-config-payload-passthrough"><span class="std std-ref">payload_passthrough</span></a> is set to
<code class="docutils literal notranslate"><span class="pre">true</span></code>, then the payload is sent to Lambda without any transformations.
<em>Note</em>: This means you lose access to all the HTTP headers in the Lambda function.</p>
<p>However, if <a class="reference internal" href="../../../api-v3/extensions/filters/http/aws_lambda/v3/aws_lambda.proto.html#envoy-v3-api-field-extensions-filters-http-aws-lambda-v3-config-payload-passthrough"><span class="std std-ref">payload_passthrough</span></a>
is set to <code class="docutils literal notranslate"><span class="pre">false</span></code>, then the HTTP request is transformed to a JSON payload with the following schema:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="nt">&quot;raw_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/path/to/resource&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;GET|POST|HEAD|...&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;header-key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;header-value&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">...</span><span class="w"> </span><span class="p">},</span>
<span class="w">     </span><span class="nt">&quot;query_string_parameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">...</span><span class="p">},</span>
<span class="w">     </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="nt">&quot;is_base64_encoded&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="err">|</span><span class="kc">false</span>
<span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">raw_path</span></code> is the HTTP request resource path (including the query string)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">method</span></code> is the HTTP request method. For example <code class="docutils literal notranslate"><span class="pre">GET</span></code>, <code class="docutils literal notranslate"><span class="pre">PUT</span></code>, etc.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">headers</span></code> are the HTTP request headers. If multiple headers share the same name, their values are
coalesced into a single comma-separated value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">query_string_parameters</span></code> are the HTTP request query string parameters. If multiple parameters share the same name,
the last one wins. That is, parameters are <strong>not</strong> coalesced into a single value if they share the same key name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">body</span></code> the body of the HTTP request is base64-encoded by the filter if the <code class="docutils literal notranslate"><span class="pre">content-type</span></code> header exists and is <strong>not</strong> one of the following:</p>
<blockquote>
<div><ul class="simple">
<li><p>text/*</p></li>
<li><p>application/json</p></li>
<li><p>application/xml</p></li>
<li><p>application/javascript</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<p>Otherwise, the body of HTTP request is added to the JSON payload as is.</p>
<p>On the other end, the response of the Lambda function must conform to the following schema:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="nt">&quot;status_code&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">...</span>
<span class="w">     </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;header-key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;header-value&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">...</span><span class="w"> </span><span class="p">},</span>
<span class="w">     </span><span class="nt">&quot;cookies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;key1=value1; HttpOnly; ...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;key2=value2; Secure; ...&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">...</span><span class="p">],</span>
<span class="w">     </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="nt">&quot;is_base64_encoded&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="err">|</span><span class="kc">false</span>
<span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">status_code</span></code> field is an integer used as the HTTP response code. If this key is missing, Envoy returns a <code class="docutils literal notranslate"><span class="pre">200</span>
<span class="pre">OK</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">headers</span></code> are used as the HTTP response headers.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">cookies</span></code> are used as <code class="docutils literal notranslate"><span class="pre">Set-Cookie</span></code> response headers. Unlike the request headers, cookies are _not_ part of the
response headers because the <code class="docutils literal notranslate"><span class="pre">Set-Cookie</span></code> header cannot contain more than one value per the <a class="reference external" href="https://tools.ietf.org/html/rfc6265#section-4.1">RFC</a>. Therefore, each
key/value pair in this JSON array will translate to a single <code class="docutils literal notranslate"><span class="pre">Set-Cookie</span></code> header.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">body</span></code> is base64-decoded if it is marked as base64-encoded and sent as the body of the HTTP response.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The target cluster must have its endpoint set to the <a class="reference external" href="https://docs.aws.amazon.com/general/latest/gr/lambda-service.html">regional Lambda endpoint</a>. Use the same region as the Lambda
function.</p>
<p>AWS IAM credentials must be defined in either environment variables, EC2 metadata or ECS task metadata.</p>
</div>
<p>The filter supports <a class="reference internal" href="../../../api-v3/extensions/filters/http/aws_lambda/v3/aws_lambda.proto.html#envoy-v3-api-msg-extensions-filters-http-aws-lambda-v3-perrouteconfig"><span class="std std-ref">per-filter configuration</span></a>.</p>
<p>If you use the per-filter configuration, the target cluster <em>must</em> have the following metadata:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/60f5f7b2c1a58fe6f61edb32c1e4c47c/aws-lambda-typed-filter.yaml"><code class="xref download docutils literal notranslate"><span class="pre">aws-lambda-typed-filter.yaml</span></code></a></span><a class="headerlink" href="#id2" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">44</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="linenos">45</span><span class="w">      </span><span class="nt">filter_metadata</span><span class="p">:</span>
<span class="linenos">46</span><span class="w">        </span><span class="nt">com.amazonaws.lambda</span><span class="p">:</span>
<span class="linenos">47</span><span class="w">          </span><span class="nt">egress_gateway</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</div>
<p>If you use the upstream filter configuration, this metadata is not required.</p>
<p>Below are some examples that show how the filter can be used in different deployment scenarios.</p>
<section id="example-configuration">
<h2>Example configuration<a class="headerlink" href="#example-configuration" title="Link to this heading"></a></h2>
<p>In this configuration, the filter applies to all routes in the filter chain of the http connection manager:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/9a745c3a8f2db353e6382dd09b6e0813/aws-lambda-filter.yaml"><code class="xref download docutils literal notranslate"><span class="pre">aws-lambda-filter.yaml</span></code></a></span><a class="headerlink" href="#id3" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">25</span><span class="w">          </span><span class="nt">http_filters</span><span class="p">:</span>
<span class="linenos">26</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.aws_lambda</span>
<span class="linenos">27</span><span class="w">            </span><span class="nt">typed_config</span><span class="p">:</span>
<span class="linenos">28</span><span class="w">              </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.aws_lambda.v3.Config</span>
<span class="linenos">29</span><span class="w">              </span><span class="nt">arn</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;arn:aws:lambda:us-west-2:987654321:function:hello_envoy&quot;</span>
<span class="linenos">30</span><span class="w">              </span><span class="nt">payload_passthrough</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</div>
<p>The corresponding regional endpoint must be specified in the target cluster. So, for example if the Lambda function is
in us-west-2:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/9a745c3a8f2db353e6382dd09b6e0813/aws-lambda-filter.yaml"><code class="xref download docutils literal notranslate"><span class="pre">aws-lambda-filter.yaml</span></code></a></span><a class="headerlink" href="#id4" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">35</span><span class="w">  </span><span class="nt">clusters</span><span class="p">:</span>
<span class="linenos">36</span><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda_egress_gateway</span>
<span class="linenos">37</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LOGICAL_DNS</span>
<span class="linenos">38</span><span class="w">    </span><span class="nt">dns_lookup_family</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">V4_ONLY</span>
<span class="linenos">39</span><span class="w">    </span><span class="nt">lb_policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ROUND_ROBIN</span>
<span class="linenos">40</span><span class="w">    </span><span class="nt">load_assignment</span><span class="p">:</span>
<span class="linenos">41</span><span class="w">      </span><span class="nt">cluster_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda_egress_gateway</span>
<span class="linenos">42</span><span class="w">      </span><span class="nt">endpoints</span><span class="p">:</span>
<span class="linenos">43</span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lb_endpoints</span><span class="p">:</span>
<span class="linenos">44</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoint</span><span class="p">:</span>
<span class="linenos">45</span><span class="w">            </span><span class="nt">address</span><span class="p">:</span>
<span class="linenos">46</span><span class="w">              </span><span class="nt">socket_address</span><span class="p">:</span>
<span class="linenos">47</span><span class="w">                </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda.us-west-2.amazonaws.com</span>
<span class="linenos">48</span><span class="w">                </span><span class="nt">port_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="linenos">49</span><span class="w">    </span><span class="nt">transport_socket</span><span class="p">:</span>
<span class="linenos">50</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.transport_sockets.tls</span>
<span class="linenos">51</span><span class="w">      </span><span class="nt">typed_config</span><span class="p">:</span>
<span class="linenos">52</span><span class="w">        </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext</span>
<span class="linenos">53</span><span class="w">        </span><span class="nt">sni</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*.amazonaws.com&quot;</span>
</pre></div>
</div>
</div>
<p>The filter can also be configured per virtual-host, route or weighted-cluster. In that case, the target cluster <em>must</em>
have specific Lambda metadata and target cluster’s endpoint should point to a region where the Lambda function is present.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/60f5f7b2c1a58fe6f61edb32c1e4c47c/aws-lambda-typed-filter.yaml"><code class="xref download docutils literal notranslate"><span class="pre">aws-lambda-typed-filter.yaml</span></code></a></span><a class="headerlink" href="#id5" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">24</span><span class="w">                  </span><span class="nt">weighted_clusters</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">                    </span><span class="nt">clusters</span><span class="p">:</span>
<span class="linenos">26</span><span class="w">                    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda_egress_gateway</span>
<span class="linenos">27</span><span class="w">                      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">42</span>
<span class="linenos">28</span><span class="w">                      </span><span class="nt">typed_per_filter_config</span><span class="p">:</span>
<span class="linenos">29</span><span class="w">                        </span><span class="nt">envoy.filters.http.aws_lambda</span><span class="p">:</span>
<span class="linenos">30</span><span class="w">                          </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.aws_lambda.v3.PerRouteConfig</span>
<span class="linenos">31</span><span class="w">                          </span><span class="nt">invoke_config</span><span class="p">:</span>
<span class="linenos">32</span><span class="w">                            </span><span class="nt">arn</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;arn:aws:lambda:us-west-1:987654321:function:hello_envoy&quot;</span>
<span class="linenos">33</span><span class="w">                            </span><span class="nt">payload_passthrough</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
</div>
<p>An example with the Lambda metadata applied to a weighted-cluster:</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/60f5f7b2c1a58fe6f61edb32c1e4c47c/aws-lambda-typed-filter.yaml"><code class="xref download docutils literal notranslate"><span class="pre">aws-lambda-typed-filter.yaml</span></code></a></span><a class="headerlink" href="#id6" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">39</span><span class="w">  </span><span class="nt">clusters</span><span class="p">:</span>
<span class="linenos">40</span><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda_egress_gateway</span>
<span class="linenos">41</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LOGICAL_DNS</span>
<span class="linenos">42</span><span class="w">    </span><span class="nt">dns_lookup_family</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">V4_ONLY</span>
<span class="linenos">43</span><span class="w">    </span><span class="nt">lb_policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ROUND_ROBIN</span>
<span class="linenos">44</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="linenos">45</span><span class="w">      </span><span class="nt">filter_metadata</span><span class="p">:</span>
<span class="linenos">46</span><span class="w">        </span><span class="nt">com.amazonaws.lambda</span><span class="p">:</span>
<span class="linenos">47</span><span class="w">          </span><span class="nt">egress_gateway</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos">48</span><span class="w">    </span><span class="nt">load_assignment</span><span class="p">:</span>
<span class="linenos">49</span><span class="w">      </span><span class="nt">cluster_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda_egress_gateway</span>
<span class="linenos">50</span><span class="w">      </span><span class="nt">endpoints</span><span class="p">:</span>
<span class="linenos">51</span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lb_endpoints</span><span class="p">:</span>
<span class="linenos">52</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoint</span><span class="p">:</span>
<span class="linenos">53</span><span class="w">            </span><span class="nt">address</span><span class="p">:</span>
<span class="linenos">54</span><span class="w">              </span><span class="nt">socket_address</span><span class="p">:</span>
<span class="linenos">55</span><span class="w">                </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda.us-west-2.amazonaws.com</span>
<span class="linenos">56</span><span class="w">                </span><span class="nt">port_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="linenos">57</span><span class="w">    </span><span class="nt">transport_socket</span><span class="p">:</span>
<span class="linenos">58</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.transport_sockets.tls</span>
<span class="linenos">59</span><span class="w">      </span><span class="nt">typed_config</span><span class="p">:</span>
<span class="linenos">60</span><span class="w">        </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext</span>
<span class="linenos">61</span><span class="w">        </span><span class="nt">sni</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*.amazonaws.com&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="configuration-as-an-upstream-http-filter">
<h2>Configuration as an upstream HTTP filter<a class="headerlink" href="#configuration-as-an-upstream-http-filter" title="Link to this heading"></a></h2>
<p>SigV4 or SigV4A request signatures are calculated using the HTTP host, URL and payload as input. Depending on the configuration, Envoy may modify one or more of
these prior to forwarding to the Cluster subsystem, but after the signature has been calculated and inserted into the HTTP headers. Modifying fields in a SigV4 or SigV4A
signed request will result in an invalid signature.</p>
<p>To avoid invalid signatures, the AWS Request Signing Filter can be configured as an upstream HTTP filter. This allows signatures to be
calculated as a final step before the HTTP request is forwarded upstream, ensuring signatures are correctly calculated over the updated
HTTP fields.</p>
<p>Configuring this filter as an upstream HTTP filter is done in a similar way to the downstream case, but using the <a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-http-filters"><span class="std std-ref">http_filters</span></a>
filter chain within the cluster configuration.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/f0a7935b695df3e6a51d674621422f7a/aws-lambda-filter-upstream.yaml"><code class="xref download docutils literal notranslate"><span class="pre">aws-lambda-filter-upstream.yaml</span></code></a></span><a class="headerlink" href="#id7" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">26</span><span class="w">  </span><span class="nt">clusters</span><span class="p">:</span>
<span class="linenos">27</span><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default_service</span>
<span class="linenos">28</span><span class="w">    </span><span class="nt">load_assignment</span><span class="p">:</span>
<span class="linenos">29</span><span class="w">      </span><span class="nt">cluster_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default_service</span>
<span class="linenos">30</span><span class="w">      </span><span class="nt">endpoints</span><span class="p">:</span>
<span class="linenos">31</span><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lb_endpoints</span><span class="p">:</span>
<span class="linenos">32</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoint</span><span class="p">:</span>
<span class="linenos">33</span><span class="w">            </span><span class="nt">address</span><span class="p">:</span>
<span class="linenos">34</span><span class="w">              </span><span class="nt">socket_address</span><span class="p">:</span>
<span class="linenos">35</span><span class="w">                </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
<span class="linenos">36</span><span class="w">                </span><span class="nt">port_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10001</span>
<span class="linenos">37</span><span class="w">    </span><span class="nt">typed_extension_protocol_options</span><span class="p">:</span>
<span class="linenos">38</span><span class="w">      </span><span class="nt">envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span><span class="p">:</span>
<span class="linenos">39</span><span class="w">        </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span>
<span class="linenos">40</span><span class="w">        </span><span class="nt">upstream_http_protocol_options</span><span class="p">:</span>
<span class="linenos">41</span><span class="w">          </span><span class="nt">auto_sni</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos">42</span><span class="w">          </span><span class="nt">auto_san_validation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos">43</span><span class="w">        </span><span class="nt">auto_config</span><span class="p">:</span>
<span class="linenos">44</span><span class="w">          </span><span class="nt">http2_protocol_options</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="linenos">45</span><span class="w">        </span><span class="nt">http_filters</span><span class="p">:</span>
<span class="linenos">46</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.aws_lambda</span>
<span class="linenos">47</span><span class="w">          </span><span class="nt">typed_config</span><span class="p">:</span>
<span class="linenos">48</span><span class="w">            </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.aws_lambda.v3.Config</span>
<span class="linenos">49</span><span class="w">            </span><span class="nt">arn</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;arn:aws:lambda:us-west-2:987654321:function:hello_envoy&quot;</span>
<span class="linenos">50</span><span class="w">            </span><span class="nt">payload_passthrough</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
</div>
</section>
<section id="credentials">
<span id="config-http-filters-aws-lambda-credentials"></span><h2>Credentials<a class="headerlink" href="#credentials" title="Link to this heading"></a></h2>
<p>The filter uses a number of different credentials providers to obtain an AWS access key ID, AWS secret access key, and AWS session token.
By default, it moves through the credentials providers in the order described below, stopping when one of them returns an access key ID and a
secret access key (the session token is optional).</p>
<ol class="arabic">
<li><p><a class="reference internal" href="../../../api-v3/extensions/common/aws/v3/credential_provider.proto.html#envoy-v3-api-field-extensions-common-aws-v3-awscredentialprovider-inline-credential"><span class="std std-ref">inline_credentials</span></a> field.
If this field is configured, no other credentials providers will be used.</p></li>
<li><p><a class="reference internal" href="../../../api-v3/extensions/filters/http/aws_request_signing/v3/aws_request_signing.proto.html#envoy-v3-api-field-extensions-filters-http-aws-request-signing-v3-awsrequestsigning-credential-provider"><span class="std std-ref">credential_provider</span></a> field.
By using this field, the filter allows override of the default credential providers, environment variables, credential parameters and file locations.
If the <a class="reference internal" href="../../../api-v3/extensions/filters/http/aws_request_signing/v3/aws_request_signing.proto.html#envoy-v3-api-field-extensions-filters-http-aws-request-signing-v3-awsrequestsigning-credential-provider"><span class="std std-ref">credential_provider</span></a> field is provided,
it can be used either to modify the default credentials provider chain, or when <a class="reference internal" href="../../../api-v3/extensions/common/aws/v3/credential_provider.proto.html#envoy-v3-api-field-extensions-common-aws-v3-awscredentialprovider-custom-credential-provider-chain"><span class="std std-ref">custom_credential_provider_chain</span></a>
is set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, to create a custom credentials provider chain containing only the specified credentials provider settings. Examples of using these fields
are provided in <a class="reference internal" href="aws_request_signing_filter.html#config-http-filters-aws-request-signing-examples"><span class="std std-ref">configuration examples</span></a>.</p></li>
<li><p>Environment variables. The environment variables <code class="docutils literal notranslate"><span class="pre">AWS_ACCESS_KEY_ID</span></code>, <code class="docutils literal notranslate"><span class="pre">AWS_SECRET_ACCESS_KEY</span></code>, and <code class="docutils literal notranslate"><span class="pre">AWS_SESSION_TOKEN</span></code> are used.</p></li>
<li><p>The AWS credentials file. The environment variables <code class="docutils literal notranslate"><span class="pre">AWS_SHARED_CREDENTIALS_FILE</span></code> and <code class="docutils literal notranslate"><span class="pre">AWS_PROFILE</span></code> are respected if they are set, else
the file <code class="docutils literal notranslate"><span class="pre">~/.aws/credentials</span></code> and profile <code class="docutils literal notranslate"><span class="pre">default</span></code> are used. The fields <code class="docutils literal notranslate"><span class="pre">aws_access_key_id</span></code>, <code class="docutils literal notranslate"><span class="pre">aws_secret_access_key</span></code>, and
<code class="docutils literal notranslate"><span class="pre">aws_session_token</span></code> defined for the profile in the credentials file are used. These credentials are cached for 1 hour.</p></li>
<li><p>From <a class="reference external" href="https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithWebIdentity.html">AssumeRoleWithWebIdentity</a> API call
towards AWS Security Token Service using <code class="docutils literal notranslate"><span class="pre">WebIdentityToken</span></code> read from a file pointed by <code class="docutils literal notranslate"><span class="pre">AWS_WEB_IDENTITY_TOKEN_FILE</span></code> environment
variable and role arn read from <code class="docutils literal notranslate"><span class="pre">AWS_ROLE_ARN</span></code> environment variable. The credentials are extracted from the fields <code class="docutils literal notranslate"><span class="pre">AccessKeyId</span></code>,
<code class="docutils literal notranslate"><span class="pre">SecretAccessKey</span></code>, and <code class="docutils literal notranslate"><span class="pre">SessionToken</span></code> are used, and credentials are cached for 1 hour or until they expire (according to the field
<code class="docutils literal notranslate"><span class="pre">Expiration</span></code>).
To fetch the credentials a static cluster is created with the name <code class="docutils literal notranslate"><span class="pre">sts_token_service_internal-&lt;region&gt;</span></code> pointing towards regional
AWS Security Token Service.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When <code class="docutils literal notranslate"><span class="pre">signing_algorithm:</span> <span class="pre">AWS_SIGV4A</span></code> is set, the STS cluster host is determined as follows:</p>
<ul class="simple">
<li><p>If your <code class="docutils literal notranslate"><span class="pre">region</span></code> (set via profile, environment, or inline) is configured as a SigV4A region set <strong>AND</strong>
contains a wildcard in the first region:</p>
<ul>
<li><p>Standard endpoint: <code class="docutils literal notranslate"><span class="pre">sts.amazonaws.com</span></code></p></li>
<li><p>FIPS endpoint: <code class="docutils literal notranslate"><span class="pre">sts-fips.us-east-1.amazonaws.com</span></code></p></li>
</ul>
</li>
<li><p>Otherwise:</p>
<ul>
<li><p>Uses regional endpoint: <code class="docutils literal notranslate"><span class="pre">sts.&lt;first-region&gt;.amazonaws.com</span></code></p></li>
</ul>
</li>
</ul>
</div>
</li>
</ol>
<blockquote>
<div><p>For alternate AWS partitions (e.g. China or GovCloud) with SigV4A signing, specify the correct regional endpoint by
setting your first SigV4A region without wildcards (example: <code class="docutils literal notranslate"><span class="pre">cn-northwest-1</span></code>)</p>
</div></blockquote>
<ol class="arabic" start="6">
<li><p>Either EC2 instance metadata, ECS task metadata or EKS Pod Identity.
For EC2 instance metadata, the fields <code class="docutils literal notranslate"><span class="pre">AccessKeyId</span></code>, <code class="docutils literal notranslate"><span class="pre">SecretAccessKey</span></code>, and <code class="docutils literal notranslate"><span class="pre">Token</span></code> are used, and credentials are cached for 1 hour.
For ECS task metadata, the fields <code class="docutils literal notranslate"><span class="pre">AccessKeyId</span></code>, <code class="docutils literal notranslate"><span class="pre">SecretAccessKey</span></code>, and <code class="docutils literal notranslate"><span class="pre">Token</span></code> are used, and credentials are cached for 1 hour or
until they expire (according to the field <code class="docutils literal notranslate"><span class="pre">Expiration</span></code>).
For EKS Pod Identity, The environment variable <code class="docutils literal notranslate"><span class="pre">AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE</span></code> will point to a mounted file in the container,
containing the string required in the Authorization header sent to the EKS Pod Identity Agent. The fields <code class="docutils literal notranslate"><span class="pre">AccessKeyId</span></code>, <code class="docutils literal notranslate"><span class="pre">SecretAccessKey</span></code>,
and <code class="docutils literal notranslate"><span class="pre">Token</span></code> are used, and credentials are cached for 1 hour or until they expire (according to the field <code class="docutils literal notranslate"><span class="pre">Expiration</span></code>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The AWS credentials provider now supports two methods for fetching credentials:</p>
<ul class="simple">
<li><p>HTTP async client (new)</p></li>
<li><p>libcurl (legacy)</p></li>
</ul>
<p>To fetch credentials from EC2 or ECS, you must configure a static cluster pointing to the credentials provider:</p>
<ul class="simple">
<li><p>For EC2: use cluster name <code class="docutils literal notranslate"><span class="pre">ec2_instance_metadata_server_internal</span></code></p></li>
<li><p>For ECS: use cluster name <code class="docutils literal notranslate"><span class="pre">ecs_task_metadata_server_internal</span></code></p></li>
</ul>
</div>
<p>These static clusters are handled automatically:</p>
<ul class="simple">
<li><p>They are added by default if not specified in bootstrap configuration.</p></li>
<li><p>They are created even when <code class="docutils literal notranslate"><span class="pre">envoy.reloadable_features.use_http_client_to_fetch_aws_credentials</span></code> is disabled. This
ensures the cluster configuration is ready when you enable HTTP client credential fetching later by setting the
reloadable feature to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p></li>
</ul>
</li>
</ol>
</section>
<section id="credential-provider-ordering">
<h2>Credential Provider Ordering<a class="headerlink" href="#credential-provider-ordering" title="Link to this heading"></a></h2>
<p>By default, credential providers will be searched for credentials in the following order:
1. <a class="reference internal" href="../../../api-v3/extensions/common/aws/v3/credential_provider.proto.html#envoy-v3-api-field-extensions-common-aws-v3-awscredentialprovider-inline-credential"><span class="std std-ref">inline_credentials</span></a>
2. <a class="reference internal" href="../../../api-v3/extensions/common/aws/v3/credential_provider.proto.html#envoy-v3-api-field-extensions-common-aws-v3-awscredentialprovider-environment-credential-provider"><span class="std std-ref">environment credential provider</span></a>
3. <a class="reference internal" href="../../../api-v3/extensions/common/aws/v3/credential_provider.proto.html#envoy-v3-api-field-extensions-common-aws-v3-awscredentialprovider-credentials-file-provider"><span class="std std-ref">credentials file provider</span></a>
4. <a class="reference internal" href="../../../api-v3/extensions/common/aws/v3/credential_provider.proto.html#envoy-v3-api-field-extensions-common-aws-v3-awscredentialprovider-assume-role-credential-provider"><span class="std std-ref">assume role credential provider</span></a>
5. <a class="reference internal" href="../../../api-v3/extensions/common/aws/v3/credential_provider.proto.html#envoy-v3-api-field-extensions-common-aws-v3-awscredentialprovider-assume-role-with-web-identity-provider"><span class="std std-ref">assume role with web identity credential provider</span></a>
6. <a class="reference internal" href="../../../api-v3/extensions/common/aws/v3/credential_provider.proto.html#envoy-v3-api-field-extensions-common-aws-v3-awscredentialprovider-container-credential-provider"><span class="std std-ref">container credential provider</span></a>
7. <a class="reference internal" href="../../../api-v3/extensions/common/aws/v3/credential_provider.proto.html#envoy-v3-api-field-extensions-common-aws-v3-awscredentialprovider-instance-profile-credential-provider"><span class="std std-ref">instance profile credential provider</span></a></p>
<p>By using the <a class="reference internal" href="../../../api-v3/extensions/filters/http/aws_request_signing/v3/aws_request_signing.proto.html#envoy-v3-api-field-extensions-filters-http-aws-request-signing-v3-awsrequestsigning-credential-provider"><span class="std std-ref">credential_provider</span></a> field you can enable only particular
providers, or override the settings for any of the configurable providers.</p>
<p>The <a class="reference internal" href="../../../api-v3/extensions/common/aws/v3/credential_provider.proto.html#envoy-v3-api-field-extensions-common-aws-v3-awscredentialprovider-assume-role-credential-provider"><span class="std std-ref">assume role credential provider</span></a> is a special case, having it’s
own <cite>credential_provider</cite> field. This is because the provider itself requires credentials to complete the <cite>sts:AssumeRole</cite> call. The default provider ordering is
the same in this case, unless you choose to override the providers and settings.</p>
</section>
<section id="statistics">
<h2>Statistics<a class="headerlink" href="#statistics" title="Link to this heading"></a></h2>
<p>The following statistics are output under the <code class="docutils literal notranslate"><span class="pre">aws.metadata_credentials_provider</span></code> namespace:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25.0%" />
<col style="width: 25.0%" />
<col style="width: 50.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>&lt;provider_cluster&gt;.credential_refreshes_performed</p></td>
<td><p>Counter</p></td>
<td><p>Total credential refreshes performed by this cluster</p></td>
</tr>
<tr class="row-odd"><td><p>&lt;provider_cluster&gt;.credential_refreshes_failed</p></td>
<td><p>Counter</p></td>
<td><p>Total credential refreshes failed by this cluster. For example, this would be incremented if a WebIdentity token was expired</p></td>
</tr>
<tr class="row-even"><td><p>&lt;provider_cluster&gt;.credential_refreshes_succeeded</p></td>
<td><p>Counter</p></td>
<td><p>Total successful credential refreshes for this cluster. Successful refresh would indicate credentials are available for signing</p></td>
</tr>
<tr class="row-odd"><td><p>&lt;provider_cluster&gt;.metadata_refresh_state</p></td>
<td><p>Gauge</p></td>
<td><p>0 means the cluster is in initial refresh state, ie no successful credential refreshes have been performed. In 0 state the cluster will attempt credential refresh up to a maximum of once every 30 seconds. 1 means the cluster is in normal credential expiration based refresh state</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id1">
<h2>Statistics<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<p>The AWS Lambda filter outputs statistics in the <em>http.&lt;stat_prefix&gt;.aws_lambda.</em> namespace. The
| <a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-stat-prefix"><span class="std std-ref">stat prefix</span></a>
comes from the owning HTTP connection manager.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25.0%" />
<col style="width: 25.0%" />
<col style="width: 50.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>server_error</p></td>
<td><p>Counter</p></td>
<td><p>Total requests that returned invalid JSON response (see <a class="reference internal" href="../../../api-v3/extensions/filters/http/aws_lambda/v3/aws_lambda.proto.html#envoy-v3-api-msg-extensions-filters-http-aws-lambda-v3-config"><span class="std std-ref">payload_passthrough</span></a>)</p></td>
</tr>
<tr class="row-odd"><td><p>upstream_rq_payload_size</p></td>
<td><p>Histogram</p></td>
<td><p>Size in bytes of the request after JSON-transformation (if any).</p></td>
</tr>
</tbody>
</table>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="admission_control_filter.html" class="btn btn-neutral float-left" title="Admission Control" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="api_key_auth_filter.html" class="btn btn-neutral float-right" title="API key auth" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2025, Envoy Project Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>