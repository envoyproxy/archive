<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HTTP connection management &mdash; envoy tag-v1.32.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d7d10ef0" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/envoy.css?v=3ec0219e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=4da122e5" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=b20634d1"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../_static/copybutton.js?v=db7b0edf"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="HTTP filters" href="http_filters.html" />
    <link rel="prev" title="HTTP" href="http.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                tag-v1.32.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../intro.html">Introduction</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../what_is_envoy.html">What is Envoy</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../arch_overview.html">Architecture overview</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../intro/intro.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listeners/listeners_toc.html">Listeners</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="http.html">HTTP</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">HTTP connection management</a></li>
<li class="toctree-l4"><a class="reference internal" href="http_filters.html">HTTP filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="http_routing.html">HTTP routing</a></li>
<li class="toctree-l4"><a class="reference internal" href="upgrades.html">HTTP upgrades</a></li>
<li class="toctree-l4"><a class="reference internal" href="http_proxy.html">HTTP dynamic forward proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="http3.html">HTTP/3 overview</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability.html">Observability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../security/security.html">Security</a></li>
<li class="toctree-l3"><a class="reference internal" href="../operations/operations.html">Operations &amp; configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../other_features/other_features.html">Other features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="../advanced/advanced.html">Advanced</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../life_of_a_request.html">Life of a Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment_types/deployment_types.html">Deployment types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_help.html">Getting help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../intro.html">Introduction</a></li>
          <li class="breadcrumb-item"><a href="../arch_overview.html">Architecture overview</a></li>
          <li class="breadcrumb-item"><a href="http.html">HTTP</a></li>
      <li class="breadcrumb-item active">HTTP connection management</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/intro/arch_overview/http/http_connection_management.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="http-connection-management">
<span id="arch-overview-http-conn-man"></span><h1>HTTP connection management<a class="headerlink" href="#http-connection-management" title="Link to this heading"></a></h1>
<p>HTTP is such a critical component of modern service oriented architectures that Envoy implements a
large amount of HTTP specific functionality. Envoy has a built in network level filter called the
<a class="reference internal" href="../../../configuration/http/http_conn_man/http_conn_man.html#config-http-conn-man"><span class="std std-ref">HTTP connection manager</span></a>.</p>
<p>This filter translates raw bytes into HTTP level messages and events (e.g., headers received,
body data received, trailers received, etc.).</p>
<p>It also handles functionality common to all HTTP connections and requests such as
<a class="reference internal" href="../observability/access_logging.html#arch-overview-access-logs"><span class="std std-ref">access logging</span></a>, <a class="reference internal" href="../observability/tracing.html#arch-overview-tracing"><span class="std std-ref">request ID generation and tracing</span></a>,
<a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers"><span class="std std-ref">request/response header manipulation</span></a>, <a class="reference internal" href="http_routing.html#arch-overview-http-routing"><span class="std std-ref">route table</span></a> management, and <a class="reference internal" href="../../../configuration/http/http_conn_man/stats.html#config-http-conn-man-stats"><span class="std std-ref">statistics</span></a>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>See the HTTP connection manager <a class="reference internal" href="../../../configuration/http/http_conn_man/http_conn_man.html#config-http-conn-man"><span class="std std-ref">configuration</span></a> and
<a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-file-envoy-extensions-filters-network-http-connection-manager-v3-http-connection-manager-proto"><span class="std std-ref">protobuf</span></a>
sections for reference documentation.</p>
</div>
<section id="http-protocols">
<span id="arch-overview-http-protocols"></span><h2>HTTP protocols<a class="headerlink" href="#http-protocols" title="Link to this heading"></a></h2>
<p>Envoy’s HTTP connection manager has native support for <strong>HTTP/1.1</strong>, <strong>HTTP/2</strong> and <strong>HTTP/3</strong>, including <strong>WebSockets</strong>.</p>
<p>Envoy’s HTTP support was designed to first and foremost be an HTTP/2 multiplexing proxy. Internally, HTTP/2 terminology
is used to describe system components. For example, an HTTP request and response take place on a “stream”.</p>
<p>A codec API is used to translate from different wire protocols into a protocol agnostic form for streams, requests, responses, etc.</p>
<p>In the case of HTTP/1.1, the codec translates the serial/pipelining capabilities of the protocol into something
that looks like HTTP/2 to higher layers. This means that the majority of the code does not need to
understand whether a stream originated on an HTTP/1.1, HTTP/2, or HTTP/3 connection.</p>
</section>
<section id="http-lifecycle">
<h2>HTTP lifecycle<a class="headerlink" href="#http-lifecycle" title="Link to this heading"></a></h2>
<p>Proxying of the request begins when the downstream HTTP codec has successfully decoded request header map.</p>
<p>The point at which the proxying completes and the stream is destroyed depends on the upstream protocol and
whether independent half close is enabled.</p>
<p>If independent half-close is enabled and the upstream protocol is either HTTP/2 or HTTP/3 protocols the stream
is destroyed after both request and response are complete i.e. reach their respective end-of-stream,
by receiving trailers or the header/body with end-stream set in both directions AND response has
success (2xx) status code.</p>
<p>For HTTP/1 upstream protocol or if independent half-close is disabled the stream is destroyed when the response
is complete and reaches its end-of-stream, i.e. when trailers or the response header/body with
end-stream set are received, even if the request has not yet completed. If the request was incomplete at response
completion, the stream is reset.</p>
<p>Note that proxying can stop early when an error or timeout occurred or when a peer reset HTTP/2 or HTTP/3 stream.</p>
</section>
<section id="http-header-sanitizing">
<h2>HTTP header sanitizing<a class="headerlink" href="#http-header-sanitizing" title="Link to this heading"></a></h2>
<p>The HTTP connection manager performs various <a class="reference internal" href="../../../configuration/http/http_conn_man/header_sanitizing.html#config-http-conn-man-header-sanitizing"><span class="std std-ref">header sanitizing</span></a> actions for security reasons.</p>
</section>
<section id="route-table-configuration">
<h2>Route table configuration<a class="headerlink" href="#route-table-configuration" title="Link to this heading"></a></h2>
<p>Each <a class="reference internal" href="../../../configuration/http/http_conn_man/http_conn_man.html#config-http-conn-man"><span class="std std-ref">HTTP connection manager filter</span></a> has an associated <a class="reference internal" href="http_routing.html#arch-overview-http-routing"><span class="std std-ref">route
table</span></a>, which can be specified in one of two ways:</p>
<ul class="simple">
<li><p>Statically.</p></li>
<li><p>Dynamically via the <a class="reference internal" href="../../../configuration/http/http_conn_man/rds.html#config-http-conn-man-rds"><span class="std std-ref">RDS API</span></a>.</p></li>
</ul>
</section>
<section id="retry-plugin-configuration">
<span id="arch-overview-http-retry-plugins"></span><h2>Retry plugin configuration<a class="headerlink" href="#retry-plugin-configuration" title="Link to this heading"></a></h2>
<p>Normally during retries, host selection follows the same process as the original request. Retry plugins
can be used to modify this behavior, and they fall into two categories:</p>
<dl>
<dt><a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-retrypolicy-retry-host-predicate"><span class="std std-ref">Host Predicates</span></a></dt><dd><p>These predicates can be used to “reject” a host, which will cause host selection to be reattempted.
Any number of these predicates can be specified, and <strong>the host will be rejected if any of the predicates reject the host</strong>.</p>
<p>Envoy supports the following built-in host predicates:</p>
<dl class="simple">
<dt><a class="reference internal" href="../../../api-v3/extensions/retry/host/previous_hosts/v3/previous_hosts.proto.html#envoy-v3-api-file-envoy-extensions-retry-host-previous-hosts-v3-previous-hosts-proto"><span class="std std-ref">PreviousHostsPredicate</span></a></dt><dd><p>This will keep track of previously attempted hosts, and rejects hosts that have already been attempted.</p>
</dd>
<dt><a class="reference internal" href="../../../api-v3/extensions/retry/host/omit_canary_hosts/v3/omit_canary_hosts.proto.html#envoy-v3-api-file-envoy-extensions-retry-host-omit-canary-hosts-v3-omit-canary-hosts-proto"><span class="std std-ref">OmitCanaryHostsPredicate</span></a></dt><dd><p>This will reject any host that is a marked as canary host.
Hosts are marked by setting <code class="docutils literal notranslate"><span class="pre">canary:</span> <span class="pre">true</span></code> for the <code class="docutils literal notranslate"><span class="pre">envoy.lb</span></code> filter in the endpoint’s filter metadata.
See <a class="reference internal" href="../../../api-v3/config/endpoint/v3/endpoint_components.proto.html#envoy-v3-api-msg-config-endpoint-v3-lbendpoint"><span class="std std-ref">LbEndpoint</span></a> for more details.</p>
</dd>
<dt><a class="reference internal" href="../../../api-v3/extensions/retry/host/omit_host_metadata/v3/omit_host_metadata_config.proto.html#envoy-v3-api-file-envoy-extensions-retry-host-omit-host-metadata-v3-omit-host-metadata-config-proto"><span class="std std-ref">OmitHostMetadataConfig</span></a></dt><dd><p>This will reject any host based on predefined metadata match criteria.
See the configuration example below for more details.</p>
</dd>
</dl>
</dd>
<dt><a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-retrypolicy-retry-priority"><span class="std std-ref">Priority Predicates</span></a></dt><dd><p>These predicates can
be used to adjust the priority load used when selecting a priority for a retry attempt. <strong>Only one priority
predicate may be specified</strong>.</p>
<p>Envoy supports the following built-in priority predicates:</p>
<dl class="simple">
<dt><a class="reference internal" href="../../../api-v3/extensions/retry/priority/previous_priorities/v3/previous_priorities_config.proto.html#envoy-v3-api-file-envoy-extensions-retry-priority-previous-priorities-v3-previous-priorities-config-proto"><span class="std std-ref">PreviousPrioritiesConfig</span></a></dt><dd><p>This will keep track of previously attempted priorities, and adjust the priority
load such that other priorities will be targeted in subsequent retry attempts.</p>
</dd>
</dl>
</dd>
</dl>
<p>Host selection will continue until either the configured predicates accept the host or a configurable
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-retrypolicy-host-selection-retry-max-attempts"><span class="std std-ref">max attempts</span></a> has been reached.</p>
<p>These plugins can be combined to affect both host selection and priority load. Envoy can also be extended
with custom retry plugins similar to how custom filters can be added.</p>
<section id="retry-configuration-examples">
<h3>Retry configuration examples<a class="headerlink" href="#retry-configuration-examples" title="Link to this heading"></a></h3>
<section id="previoushostspredicate">
<h4><code class="docutils literal notranslate"><span class="pre">PreviousHostsPredicate</span></code><a class="headerlink" href="#previoushostspredicate" title="Link to this heading"></a></h4>
<p>For example, to configure retries to prefer hosts that haven’t been attempted already, the built-in
<a class="reference internal" href="../../../api-v3/extensions/retry/host/previous_hosts/v3/previous_hosts.proto.html#envoy-v3-api-file-envoy-extensions-retry-host-previous-hosts-v3-previous-hosts-proto"><span class="std std-ref">PreviousHostsPredicate</span></a>
can be used:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/26839fd8ace62acc309681d35dab6fdd/retry-previous-hosts.yaml"><code class="xref download docutils literal notranslate"><span class="pre">retry-previous-hosts.yaml</span></code></a></span><a class="headerlink" href="#id1" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">24</span><span class="w">              </span><span class="nt">routes</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="linenos">26</span><span class="w">                  </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="linenos">27</span><span class="w">                </span><span class="nt">route</span><span class="p">:</span>
<span class="linenos">28</span><span class="w">                  </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster_0</span>
<span class="hll"><span class="linenos">29</span><span class="w">                  </span><span class="nt">retry_policy</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">30</span><span class="w">                    </span><span class="nt">retry_host_predicate</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">31</span><span class="w">                    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.retry_host_predicates.previous_hosts</span>
</span><span class="hll"><span class="linenos">32</span><span class="w">                      </span><span class="nt">typed_config</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">33</span><span class="w">                        </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.retry.host.previous_hosts.v3.PreviousHostsPredicate</span>
</span><span class="hll"><span class="linenos">34</span><span class="w">                    </span><span class="nt">host_selection_retry_max_attempts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span class="linenos">35</span>
<span class="linenos">36</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">clusters</span><span class="p">:</span>
</pre></div>
</div>
</div>
<p>This will reject hosts previously attempted, retrying host selection a maximum of 3 times. The bound
on attempts is necessary in order to deal with scenarios in which finding an acceptable host is either
impossible (no hosts satisfy the predicate) or very unlikely (the only suitable host has a very low
relative weight).</p>
</section>
<section id="omithostmetadataconfig">
<h4><code class="docutils literal notranslate"><span class="pre">OmitHostMetadataConfig</span></code><a class="headerlink" href="#omithostmetadataconfig" title="Link to this heading"></a></h4>
<p>To reject a host based on its metadata,
<a class="reference internal" href="../../../api-v3/extensions/retry/host/omit_host_metadata/v3/omit_host_metadata_config.proto.html#envoy-v3-api-file-envoy-extensions-retry-host-omit-host-metadata-v3-omit-host-metadata-config-proto"><span class="std std-ref">OmitHostMetadataConfig</span></a>
can be used:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/7068c28039f68b3d0e83199a72d7c98b/retry-omit-host-metadata.yaml"><code class="xref download docutils literal notranslate"><span class="pre">retry-omit-host-metadata.yaml</span></code></a></span><a class="headerlink" href="#id2" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">24</span><span class="w">              </span><span class="nt">routes</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="linenos">26</span><span class="w">                  </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="linenos">27</span><span class="w">                </span><span class="nt">route</span><span class="p">:</span>
<span class="linenos">28</span><span class="w">                  </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster_0</span>
<span class="hll"><span class="linenos">29</span><span class="w">                  </span><span class="nt">retry_policy</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">30</span><span class="w">                    </span><span class="nt">retry_host_predicate</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">31</span><span class="w">                    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.retry_host_predicates.omit_host_metadata</span>
</span><span class="hll"><span class="linenos">32</span><span class="w">                      </span><span class="nt">typed_config</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">33</span><span class="w">                        </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.retry.host.omit_host_metadata.v3.OmitHostMetadataConfig</span>
</span><span class="hll"><span class="linenos">34</span><span class="w">                        </span><span class="nt">metadata_match</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">35</span><span class="w">                          </span><span class="nt">filter_metadata</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">36</span><span class="w">                            </span><span class="nt">envoy.lb</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">37</span><span class="w">                              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">value</span>
</span><span class="linenos">38</span>
<span class="linenos">39</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">clusters</span><span class="p">:</span>
</pre></div>
</div>
</div>
<p>This will reject any host with matching (key, value) in its metadata.</p>
</section>
<section id="previousprioritiesconfig">
<h4><code class="docutils literal notranslate"><span class="pre">PreviousPrioritiesConfig</span></code><a class="headerlink" href="#previousprioritiesconfig" title="Link to this heading"></a></h4>
<p>To configure retries to attempt other priorities during retries, the built-in
<a class="reference internal" href="../../../api-v3/extensions/retry/priority/previous_priorities/v3/previous_priorities_config.proto.html#envoy-v3-api-file-envoy-extensions-retry-priority-previous-priorities-v3-previous-priorities-config-proto"><span class="std std-ref">PreviousPrioritiesConfig</span></a>
can be used.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/b3ac02aa3ae16683880f1e6bb48df66d/retry-previous-priorities.yaml"><code class="xref download docutils literal notranslate"><span class="pre">retry-previous-priorities.yaml</span></code></a></span><a class="headerlink" href="#id3" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">24</span><span class="w">              </span><span class="nt">routes</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="linenos">26</span><span class="w">                  </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="linenos">27</span><span class="w">                </span><span class="nt">route</span><span class="p">:</span>
<span class="linenos">28</span><span class="w">                  </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster_0</span>
<span class="hll"><span class="linenos">29</span><span class="w">                  </span><span class="nt">retry_policy</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">30</span><span class="w">                    </span><span class="nt">retry_priority</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">31</span><span class="w">                      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.retry_priorities.previous_priorities</span>
</span><span class="hll"><span class="linenos">32</span><span class="w">                      </span><span class="nt">typed_config</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">33</span><span class="w">                        </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.retry.priority.previous_priorities.v3.PreviousPrioritiesConfig</span>
</span><span class="hll"><span class="linenos">34</span><span class="w">                        </span><span class="nt">update_frequency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span class="linenos">35</span>
<span class="linenos">36</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">clusters</span><span class="p">:</span>
</pre></div>
</div>
</div>
<p>This will target priorities in subsequent retry attempts that haven’t been already used. The
<a class="reference internal" href="../../../api-v3/extensions/retry/priority/previous_priorities/v3/previous_priorities_config.proto.html#envoy-v3-api-field-extensions-retry-priority-previous-priorities-v3-previousprioritiesconfig-update-frequency"><span class="std std-ref">update_frequency</span></a>
parameter decides how often the priority load should be recalculated.</p>
</section>
<section id="combined-retry-policy">
<h4>Combined retry policy<a class="headerlink" href="#combined-retry-policy" title="Link to this heading"></a></h4>
<p>These plugins can be combined, which will exclude both previously attempted hosts as well as
previously attempted priorities.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../_downloads/118b46ea90fdbc43ca1844285666eb57/retry-combined-hosts-priorities.yaml"><code class="xref download docutils literal notranslate"><span class="pre">retry-combined-hosts-priorities.yaml</span></code></a></span><a class="headerlink" href="#id4" title="Link to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">24</span><span class="w">              </span><span class="nt">routes</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="linenos">26</span><span class="w">                  </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="linenos">27</span><span class="w">                </span><span class="nt">route</span><span class="p">:</span>
<span class="linenos">28</span><span class="w">                  </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster_0</span>
<span class="hll"><span class="linenos">29</span><span class="w">                  </span><span class="nt">retry_policy</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">30</span><span class="w">                    </span><span class="nt">retry_host_predicate</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">31</span><span class="w">                    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.retry_host_predicates.previous_hosts</span>
</span><span class="hll"><span class="linenos">32</span><span class="w">                      </span><span class="nt">typed_config</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">33</span><span class="w">                        </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.retry.host.previous_hosts.v3.PreviousHostsPredicate</span>
</span><span class="hll"><span class="linenos">34</span><span class="w">                    </span><span class="nt">host_selection_retry_max_attempts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span class="hll"><span class="linenos">35</span><span class="w">                    </span><span class="nt">retry_priority</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">36</span><span class="w">                      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.retry_priorities.previous_priorities</span>
</span><span class="hll"><span class="linenos">37</span><span class="w">                      </span><span class="nt">typed_config</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">38</span><span class="w">                        </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.retry.priority.previous_priorities.v3.PreviousPrioritiesConfig</span>
</span><span class="hll"><span class="linenos">39</span><span class="w">                        </span><span class="nt">update_frequency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span class="linenos">40</span>
<span class="linenos">41</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">clusters</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>
<section id="internal-redirects">
<span id="arch-overview-internal-redirects"></span><h2>Internal redirects<a class="headerlink" href="#internal-redirects" title="Link to this heading"></a></h2>
<p>Envoy supports handling 3xx redirects internally, that is capturing a configurable 3xx redirect
response, synthesizing a new request, sending it to the upstream specified by the new route match,
and returning the redirected response as the response to the original request. The headers and body
of the original request will be sent in the redirect to the new location. Trailers are not yet
supported.</p>
<p>Internal redirects are configured via the <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-internal-redirect-policy"><span class="std std-ref">internal_redirect_policy</span></a> field in route configuration.
When redirect handling is on, any 3xx response from upstream, that matches
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-internalredirectpolicy-redirect-response-codes"><span class="std std-ref">redirect_response_codes</span></a>
is subject to the redirect being handled by Envoy.</p>
<p>If Envoy is configured to internally redirect HTTP <code class="docutils literal notranslate"><span class="pre">303</span></code> and receives an HTTP <code class="docutils literal notranslate"><span class="pre">303</span></code> response, it will
dispatch the redirect with a bodiless HTTP <code class="docutils literal notranslate"><span class="pre">GET</span></code> if the original request was not a <code class="docutils literal notranslate"><span class="pre">GET</span></code> or <code class="docutils literal notranslate"><span class="pre">HEAD</span></code>
request. Otherwise, Envoy will preserve the original HTTP method. For more information, see <a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-6.4.4">RFC
7231 Section 6.4.4</a>.</p>
<p>For a redirect to be handled successfully it <strong>must</strong> pass the following checks:</p>
<ol class="arabic simple">
<li><p>Have a response code matching one of <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-internalredirectpolicy-redirect-response-codes"><span class="std std-ref">redirect_response_codes</span></a>, which is
either <code class="docutils literal notranslate"><span class="pre">302</span></code> (by default), or a set of 3xx codes (<code class="docutils literal notranslate"><span class="pre">301</span></code>, <code class="docutils literal notranslate"><span class="pre">302</span></code>, <code class="docutils literal notranslate"><span class="pre">303</span></code>, <code class="docutils literal notranslate"><span class="pre">307</span></code>, <code class="docutils literal notranslate"><span class="pre">308</span></code>).</p></li>
<li><p>Have a <code class="docutils literal notranslate"><span class="pre">location</span></code> header with a valid, fully qualified URL.</p></li>
<li><p>The request must have been fully processed by Envoy.</p></li>
<li><p>The request must be smaller than the <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-route-per-request-buffer-limit-bytes"><span class="std std-ref">per_request_buffer_limit_bytes</span></a> limit.</p></li>
<li><p><a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-internalredirectpolicy-allow-cross-scheme-redirect"><span class="std std-ref">allow_cross_scheme_redirect</span></a> is <code class="docutils literal notranslate"><span class="pre">true</span></code> (default to <code class="docutils literal notranslate"><span class="pre">false</span></code>),
or the scheme of the downstream request and the <code class="docutils literal notranslate"><span class="pre">location</span></code> header are the same.</p></li>
<li><p>The number of previously handled internal redirect within a given downstream request does not
exceed <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-internalredirectpolicy-max-internal-redirects"><span class="std std-ref">max_internal_redirects</span></a>
of the route that the request or redirected request is hitting.</p></li>
<li><p>All <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-internalredirectpolicy-predicates"><span class="std std-ref">predicates</span></a> accept
the target route.</p></li>
</ol>
<p>Any failure will result in the redirect being passed downstream instead.</p>
<p>Since a redirected request may be bounced between different routes, any route in the chain of redirects that …</p>
<ul class="simple">
<li><p>does not have internal redirect enabled</p></li>
<li><p><em>or,</em> has a <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-internalredirectpolicy-max-internal-redirects"><span class="std std-ref">max_internal_redirects</span></a>
smaller or equal to the redirect chain length when the redirect chain hits it</p></li>
<li><p><em>or,</em> is disallowed by any of the <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-internalredirectpolicy-predicates"><span class="std std-ref">predicates</span></a></p></li>
</ul>
<p>... will cause the redirect to be passed downstream.</p>
<p>Two predicates can be used to create a DAG that defines the redirect chain, the <a class="reference internal" href="../../../api-v3/extensions/internal_redirect/previous_routes/v3/previous_routes_config.proto.html#envoy-v3-api-msg-extensions-internal-redirect-previous-routes-v3-previousroutesconfig"><span class="std std-ref">previous_routes</span></a> predicate, and
the <a class="reference internal" href="../../../api-v3/extensions/internal_redirect/allow_listed_routes/v3/allow_listed_routes_config.proto.html#envoy-v3-api-msg-extensions-internal-redirect-allow-listed-routes-v3-allowlistedroutesconfig"><span class="std std-ref">allow_listed_routes</span></a>.
Specifically, the <a class="reference internal" href="../../../api-v3/extensions/internal_redirect/allow_listed_routes/v3/allow_listed_routes_config.proto.html#envoy-v3-api-msg-extensions-internal-redirect-allow-listed-routes-v3-allowlistedroutesconfig"><span class="std std-ref">allow_listed_routes</span></a> predicate
defines edges of individual node in the DAG and the <a class="reference internal" href="../../../api-v3/extensions/internal_redirect/previous_routes/v3/previous_routes_config.proto.html#envoy-v3-api-msg-extensions-internal-redirect-previous-routes-v3-previousroutesconfig"><span class="std std-ref">previous_routes</span></a> predicate defines
“visited” state of the edges, so that loop can be avoided if so desired.</p>
<p>A third predicate <a class="reference internal" href="../../../api-v3/extensions/internal_redirect/safe_cross_scheme/v3/safe_cross_scheme_config.proto.html#envoy-v3-api-msg-extensions-internal-redirect-safe-cross-scheme-v3-safecrossschemeconfig"><span class="std std-ref">safe_cross_scheme</span></a>
can be used to prevent HTTP -&gt; HTTPS redirect.</p>
<p>Once the redirect has passed these checks, the request headers which were shipped to the original
upstream will be modified by:</p>
<ol class="arabic simple">
<li><p>Putting the fully qualified original request URL in the <code class="docutils literal notranslate"><span class="pre">x-envoy-original-url</span></code> header.</p></li>
<li><p>Replacing the <code class="docutils literal notranslate"><span class="pre">Authority</span></code>/<code class="docutils literal notranslate"><span class="pre">Host</span></code>, <code class="docutils literal notranslate"><span class="pre">Scheme</span></code>, and <code class="docutils literal notranslate"><span class="pre">Path</span></code> headers with the values from the <code class="docutils literal notranslate"><span class="pre">Location</span></code> header.</p></li>
<li><p>Copying any headers listed in
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-internalredirectpolicy-response-headers-to-copy"><span class="std std-ref">response_headers_to_copy</span></a>
from the redirect response into the headers that will be used in the
subsequent request.</p></li>
</ol>
<p>The altered request headers will then have a new route selected, be sent through a new filter chain,
and then shipped upstream with all of the normal Envoy request sanitization taking place.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Note that HTTP connection manager sanitization such as clearing untrusted headers will only be
applied once. Per-route header modifications will be applied on both the original route and the
second route, even if they are the same, so be careful configuring header modification rules to
avoid duplicating undesired header values.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Note that no downstream filters will see the response that triggers the internal redirect. If there is a need
to pass data between the redirect response and the followup request, see
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-internalredirectpolicy-response-headers-to-copy"><span class="std std-ref">response_headers_to_copy</span></a>.</p>
</div>
<p>A sample redirect flow might look like this:</p>
<ol class="arabic simple">
<li><p>Client sends a <code class="docutils literal notranslate"><span class="pre">GET</span></code> request for <a class="reference external" href="http://foo.com/bar">http://foo.com/bar</a>.</p></li>
<li><p>Upstream 1 sends a <code class="docutils literal notranslate"><span class="pre">302</span></code> with  <code class="docutils literal notranslate"><span class="pre">location:</span> <span class="pre">http://baz.com/eep</span></code>.</p></li>
<li><p>Envoy is configured to allow redirects on the original route, and sends a new <code class="docutils literal notranslate"><span class="pre">GET</span></code> request to
Upstream 2, to fetch <a class="reference external" href="http://baz.com/eep">http://baz.com/eep</a> with the additional request header
<code class="docutils literal notranslate"><span class="pre">x-envoy-original-url:</span> <span class="pre">http://foo.com/bar</span></code>.</p></li>
<li><p>Envoy proxies the response data for <a class="reference external" href="http://baz.com/eep">http://baz.com/eep</a> to the client as the response to the original
request.</p></li>
</ol>
</section>
<section id="timeouts">
<h2>Timeouts<a class="headerlink" href="#timeouts" title="Link to this heading"></a></h2>
<p>Various configurable timeouts apply to an HTTP connection and its constituent streams. Please see
<a class="reference internal" href="../../../faq/configuration/timeouts.html#faq-configuration-timeouts"><span class="std std-ref">this FAQ entry</span></a> for an overview of important timeout
configuration.</p>
</section>
<section id="http-header-map-settings">
<span id="arch-overview-http-header-map-settings"></span><h2>HTTP header map settings<a class="headerlink" href="#http-header-map-settings" title="Link to this heading"></a></h2>
<p>Envoy maintains the insertion order of headers (and pseudo headers that begin with <code class="docutils literal notranslate"><span class="pre">:</span></code>) in the
HTTP header map using a linked list data-structure, which is very fast when the number of headers
is small.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="http.html" class="btn btn-neutral float-left" title="HTTP" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="http_filters.html" class="btn btn-neutral float-right" title="HTTP filters" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2024, Envoy Project Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>