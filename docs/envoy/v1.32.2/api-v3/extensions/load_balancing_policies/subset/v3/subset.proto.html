<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subset Load Balancing Policy (proto) &mdash; envoy tag-v1.32.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=d7d10ef0" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/envoy.css?v=3ec0219e" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/tabs.css?v=4da122e5" />

  
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=21863aa2"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../../../_static/copybutton.js?v=db7b0edf"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="Cluster specifier" href="../../../../config/cluster_specifier/cluster_specifier.html" />
    <link rel="prev" title="Round Robin Load Balancing Policy (proto)" href="../../round_robin/v3/round_robin.proto.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html">
            
              <img src="../../../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                tag-v1.32.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../../api/api.html">API</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../../api/api_supported_versions.html">Supported API versions</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../../api.html">v3 API reference</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../../bootstrap/bootstrap.html">Bootstrap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../listeners/listeners.html">Listeners</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../clusters/clusters.html">Clusters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../http_routes/http_routes.html">HTTP route management</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../../../config/config.html">Extensions</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../../../../config/accesslog/filters.html">Access log extension filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/formatter/formatter.html">Access log formatters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/accesslog/accesslog.html">Access loggers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/cluster/cluster.html">Cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/common/common.html">Common</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/compression/compression.html">Compression</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/config_validators/config_validators.html">Config validators</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/contrib/contrib.html">Contrib extensions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/dns_resolver/dns_resolver.html">DNS resolver</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/endpoint/endpoint.html">Endpoint</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/filter/filter.html">Filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/grpc_credential/grpc_credential.html">Grpc credentials</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/health_check_event_sinks/health_check_event_sinks.html">Health check event sinks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/health_checker/health_checker.html">Health checkers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/http/early_header_mutation.html">HTTP early header mutation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/http/custom_response.html">Custom response policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/http/header_formatters.html">HTTP header formatters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/http/header_validators.html">HTTP header validators</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/http/original_ip_detection.html">HTTP original IP detection</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/http/stateful_session.html">HTTP stateful session</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/injected_credentials/injected_credentials.html">Injected credentials</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/geoip_provider/geoip_provider.html">Geolocation providers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/trace/trace.html">HTTP tracers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/internal_redirect/internal_redirect.html">Internal redirect predicates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/path/match/path_matcher.html">Path matcher</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/path/rewrite/path_rewriter.html">Path rewriter</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/quic/quic_extensions.html">Quic extensions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/descriptors/descriptors.html">Rate limit descriptors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/rbac/rbac.html">RBAC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/rbac/matchers.html">RBAC matchers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/request_id/request_id.html">Request ID</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/resource_monitor/resource_monitor.html">Resource monitors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/retry/retry.html">Retry predicates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/stat_sinks/stat_sinks.html">Stat sinks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/string_matcher/string_matcher.html">String Matcher</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/transport_socket/transport_socket.html">Transport sockets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/upstream/upstream.html">Upstream configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/wasm/wasm.html">WASM</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/watchdog/watchdog.html">Watchdog</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="../../../../config/load_balancing_policies/load_balancing_policies.html">Load balancing policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../config/cluster_specifier/cluster_specifier.html">Cluster specifier</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../admin/admin.html">Admin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../data/data.html">Envoy data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../service/service.html">Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../common_messages/common_messages.html">Common messages</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../common_messages/common_messages_xds.html">Common messages (XDS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../types/types.html">Types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../api-docs/xds_protocol.html">xDS REST and gRPC protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../api/client_features.html">Well Known Client Features</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../version_history/version_history.html">Version history</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">envoy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../../api/api.html">API</a></li>
          <li class="breadcrumb-item"><a href="../../../../api.html">v3 API reference</a></li>
          <li class="breadcrumb-item"><a href="../../../../config/config.html">Extensions</a></li>
          <li class="breadcrumb-item"><a href="../../../../config/load_balancing_policies/load_balancing_policies.html">Load balancing policies</a></li>
      <li class="breadcrumb-item active">Subset Load Balancing Policy (proto)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../_sources/api-v3/extensions/load_balancing_policies/subset/v3/subset.proto.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="subset-load-balancing-policy-proto">
<span id="envoy-v3-api-file-envoy-extensions-load-balancing-policies-subset-v3-subset-proto"></span><h1>Subset Load Balancing Policy (proto)<a class="headerlink" href="#subset-load-balancing-policy-proto" title="Link to this heading"></a></h1>
<p id="extension-envoy-load-balancing-policies-subset">This extension has the qualified name <code class="docutils literal notranslate"><span class="pre">envoy.load_balancing_policies.subset</span></code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This extension is intended to be robust against both untrusted downstream and
upstream traffic.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This extension extends and can be used with the following extension category:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../../../config/cluster/v3/cluster.proto.html#extension-category-envoy-load-balancing-policies"><span class="std std-ref">envoy.load_balancing_policies</span></a></p></li>
</ul>
<p>This extension must be configured with one of the following type URLs:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#envoy-v3-api-msg-extensions-load-balancing-policies-subset-v3-subset"><span class="std std-ref">type.googleapis.com/envoy.extensions.load_balancing_policies.subset.v3.Subset</span></a></p></li>
</ul>
</div>
<section id="extensions-load-balancing-policies-subset-v3-subset">
<span id="envoy-v3-api-msg-extensions-load-balancing-policies-subset-v3-subset"></span><h2>extensions.load_balancing_policies.subset.v3.Subset<a class="headerlink" href="#extensions-load-balancing-policies-subset-v3-subset" title="Link to this heading"></a></h2>
<p><a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.32.2/api/envoy/extensions/load_balancing_policies/subset/v3/subset.proto#L24">[extensions.load_balancing_policies.subset.v3.Subset proto]</a></p>
<p>Optionally divide the endpoints in this cluster into subsets defined by
endpoint metadata and selected by route and weighted cluster metadata.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;fallback_policy&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">...</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;default_subset&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;subset_selectors&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">  </span><span class="nt">&quot;allow_redundant_keys&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">...</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;locality_weight_aware&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">...</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;scale_locality_weight&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">...</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;panic_mode_any&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">...</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;list_as_any&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">...</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;metadata_fallback_policy&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">...</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;subset_lb_policy&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<dl class="simple" id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-fallback-policy">
<dt>fallback_policy</dt><dd><p>(<a class="reference internal" href="#envoy-v3-api-enum-extensions-load-balancing-policies-subset-v3-subset-lbsubsetfallbackpolicy"><span class="std std-ref">extensions.load_balancing_policies.subset.v3.Subset.LbSubsetFallbackPolicy</span></a>) The behavior used when no endpoint subset matches the selected route’s
metadata. The value defaults to
<a class="reference internal" href="#envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetfallbackpolicy-no-fallback"><span class="std std-ref">NO_FALLBACK</span></a>.</p>
</dd>
</dl>
<dl class="simple" id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-default-subset">
<dt>default_subset</dt><dd><p>(<a class="reference external" href="https://developers.google.com/protocol-buffers/docs/reference/google.protobuf#struct">Struct</a>) Specifies the default subset of endpoints used during fallback if
fallback_policy is
<a class="reference internal" href="#envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetfallbackpolicy-default-subset"><span class="std std-ref">DEFAULT_SUBSET</span></a>.
Each field in default_subset is
compared to the matching LbEndpoint.Metadata under the <code class="docutils literal notranslate"><span class="pre">envoy.lb</span></code>
namespace. It is valid for no hosts to match, in which case the behavior
is the same as a fallback_policy of
<a class="reference internal" href="#envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetfallbackpolicy-no-fallback"><span class="std std-ref">NO_FALLBACK</span></a>.</p>
</dd>
</dl>
<dl id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-subset-selectors">
<dt>subset_selectors</dt><dd><p>(<strong>repeated</strong> <a class="reference internal" href="#envoy-v3-api-msg-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector"><span class="std std-ref">extensions.load_balancing_policies.subset.v3.Subset.LbSubsetSelector</span></a>) For each entry, LbEndpoint.Metadata’s
<code class="docutils literal notranslate"><span class="pre">envoy.lb</span></code> namespace is traversed and a subset is created for each unique
combination of key and value. For example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;subset_selectors&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;keys&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;version&quot;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;keys&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;stage&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;hardware_type&quot;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>A subset is matched when the metadata from the selected route and
weighted cluster contains the same keys and values as the subset’s
metadata. The same host may appear in multiple subsets.</p>
</dd>
</dl>
<dl id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-allow-redundant-keys">
<dt>allow_redundant_keys</dt><dd><p>(<a class="reference external" href="https://developers.google.com/protocol-buffers/docs/proto#scalar">bool</a>) By default, only when the request metadata has exactly the <strong>same</strong> keys as one of subset selectors and
the values of the related keys are matched, the load balancer will have a valid subset for the request.
For example, given the following subset selectors:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;subset_selectors&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;keys&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;version&quot;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;keys&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;stage&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;version&quot;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>A request with metadata <code class="docutils literal notranslate"><span class="pre">{&quot;redundant-key&quot;:</span> <span class="pre">&quot;redundant-value&quot;,</span> <span class="pre">&quot;stage&quot;:</span> <span class="pre">&quot;prod&quot;,</span> <span class="pre">&quot;version&quot;:</span> <span class="pre">&quot;v1&quot;}</span></code> or
<code class="docutils literal notranslate"><span class="pre">{&quot;redundant-key&quot;:</span> <span class="pre">&quot;redundant-value&quot;,</span> <span class="pre">&quot;version&quot;:</span> <span class="pre">&quot;v1&quot;}</span></code> will not have a valid subset even if the values
of keys <code class="docutils literal notranslate"><span class="pre">stage</span></code> and <code class="docutils literal notranslate"><span class="pre">version</span></code> are matched because of the redundant key/value pair in the request
metadata.</p>
<p>By setting this field to true, the most appropriate keys will be filtered out from the request metadata
according to the subset selectors. And then the filtered keys and related values will be matched to find
the valid host subset. By this way, redundant key/value pairs are allowed in the request metadata. The keys
of a request metadata could be superset of the keys of the subset selectors and need not to be exactly the
same as the keys of the subset selectors.</p>
<p>More specifically, if the keys of a request metadata is a superset of one of the subset selectors, then only
the values of the keys that in the selector keys will be matched. Take the above example, if the request
metadata is <code class="docutils literal notranslate"><span class="pre">{&quot;redundant-key&quot;:</span> <span class="pre">&quot;redundant-value&quot;,</span> <span class="pre">&quot;stage&quot;:</span> <span class="pre">&quot;prod&quot;,</span> <span class="pre">&quot;version&quot;:</span> <span class="pre">&quot;v1&quot;}</span></code>, the load balancer
will only match the values of <code class="docutils literal notranslate"><span class="pre">stage</span></code> and <code class="docutils literal notranslate"><span class="pre">version</span></code> to find an appropriate subset because <code class="docutils literal notranslate"><span class="pre">stage</span></code>
<code class="docutils literal notranslate"><span class="pre">version</span></code> are contained by the second subset selector and the redundant <code class="docutils literal notranslate"><span class="pre">redundant-key</span></code> will be
ignored.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the keys of request metadata is superset of multiple different subset selectors keys, the subset
selector with most keys to win. For example, given subset selectors
<code class="docutils literal notranslate"><span class="pre">{&quot;subset_selectors&quot;:</span> <span class="pre">[&quot;keys&quot;:</span> <span class="pre">[&quot;A&quot;,</span> <span class="pre">&quot;B&quot;,</span> <span class="pre">&quot;C&quot;],</span> <span class="pre">[&quot;A&quot;,</span> <span class="pre">&quot;B&quot;]]}</span></code> and request metadata <code class="docutils literal notranslate"><span class="pre">{&quot;A&quot;:</span> <span class="pre">&quot;-&quot;,</span>
<span class="pre">&quot;B&quot;:</span> <span class="pre">&quot;-&quot;,</span> <span class="pre">&quot;C&quot;:</span> <span class="pre">&quot;-&quot;,</span> <span class="pre">&quot;D&quot;:</span> <span class="pre">&quot;-&quot;}</span></code>, keys <code class="docutils literal notranslate"><span class="pre">A</span></code>, <code class="docutils literal notranslate"><span class="pre">B</span></code>, <code class="docutils literal notranslate"><span class="pre">C</span></code> will be evaluated.
If the keys of request metadata is superset of multiple different subset selectors keys and the number
of selector keys are same, then the one placed in front to win. For example, given subset selectors
<code class="docutils literal notranslate"><span class="pre">{&quot;subset_selectors&quot;:</span> <span class="pre">[&quot;keys&quot;:</span> <span class="pre">[&quot;A&quot;,</span> <span class="pre">&quot;B&quot;],</span> <span class="pre">[&quot;C&quot;,</span> <span class="pre">&quot;D&quot;]]}</span></code> and request metadata <code class="docutils literal notranslate"><span class="pre">{&quot;A&quot;:</span> <span class="pre">&quot;-&quot;,</span> <span class="pre">&quot;B&quot;:</span> <span class="pre">&quot;-&quot;,</span>
<span class="pre">&quot;C&quot;:</span> <span class="pre">&quot;-&quot;,</span> <span class="pre">&quot;D&quot;:</span> <span class="pre">&quot;-&quot;}</span></code>, keys <code class="docutils literal notranslate"><span class="pre">A</span></code>, <code class="docutils literal notranslate"><span class="pre">B</span></code> will be evaluated.</p>
</div>
</dd>
</dl>
<dl id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-locality-weight-aware">
<dt>locality_weight_aware</dt><dd><p>(<a class="reference external" href="https://developers.google.com/protocol-buffers/docs/proto#scalar">bool</a>) If true, routing to subsets will take into account the localities and locality weights of the
endpoints when making the routing decision.</p>
<p>There are some potential pitfalls associated with enabling this feature, as the resulting
traffic split after applying both a subset match and locality weights might be undesirable.</p>
<p>Consider for example a situation in which you have 50/50 split across two localities X/Y
which have 100 hosts each without subsetting. If the subset LB results in X having only 1
host selected but Y having 100, then a lot more load is being dumped on the single host in X
than originally anticipated in the load balancing assignment delivered via EDS.</p>
</dd>
</dl>
<dl class="simple" id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-scale-locality-weight">
<dt>scale_locality_weight</dt><dd><p>(<a class="reference external" href="https://developers.google.com/protocol-buffers/docs/proto#scalar">bool</a>) When used with locality_weight_aware, scales the weight of each locality by the ratio
of hosts in the subset vs hosts in the original subset. This aims to even out the load
going to an individual locality if said locality is disproportionately affected by the
subset predicate.</p>
</dd>
</dl>
<dl id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-panic-mode-any">
<dt>panic_mode_any</dt><dd><p>(<a class="reference external" href="https://developers.google.com/protocol-buffers/docs/proto#scalar">bool</a>) If true, when a fallback policy is configured and its corresponding subset fails to find
a host this will cause any host to be selected instead.</p>
<p>This is useful when using the default subset as the fallback policy, given the default
subset might become empty. With this option enabled, if that happens the LB will attempt
to select a host from the entire cluster.</p>
</dd>
</dl>
<dl class="simple" id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-list-as-any">
<dt>list_as_any</dt><dd><p>(<a class="reference external" href="https://developers.google.com/protocol-buffers/docs/proto#scalar">bool</a>) If true, metadata specified for a metadata key will be matched against the corresponding
endpoint metadata if the endpoint metadata matches the value exactly OR it is a list value
and any of the elements in the list matches the criteria.</p>
</dd>
</dl>
<dl id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-metadata-fallback-policy">
<dt>metadata_fallback_policy</dt><dd><p>(<a class="reference internal" href="#envoy-v3-api-enum-extensions-load-balancing-policies-subset-v3-subset-lbsubsetmetadatafallbackpolicy"><span class="std std-ref">extensions.load_balancing_policies.subset.v3.Subset.LbSubsetMetadataFallbackPolicy</span></a>) Fallback mechanism that allows to try different route metadata until a host is found.
If load balancing process, including all its mechanisms (like
<a class="reference internal" href="#envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-fallback-policy"><span class="std std-ref">fallback_policy</span></a>)
fails to select a host, this policy decides if and how the process is repeated using another metadata.</p>
<p>The value defaults to
<a class="reference internal" href="#envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetmetadatafallbackpolicy-metadata-no-fallback"><span class="std std-ref">METADATA_NO_FALLBACK</span></a>.</p>
</dd>
</dl>
<dl class="simple" id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-subset-lb-policy">
<dt>subset_lb_policy</dt><dd><p>(<a class="reference internal" href="../../../../config/cluster/v3/cluster.proto.html#envoy-v3-api-msg-config-cluster-v3-loadbalancingpolicy"><span class="std std-ref">config.cluster.v3.LoadBalancingPolicy</span></a>, <em>REQUIRED</em>) The child LB policy to create for endpoint-picking within the chosen subset.</p>
</dd>
</dl>
</section>
<section id="extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector">
<span id="envoy-v3-api-msg-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector"></span><h2>extensions.load_balancing_policies.subset.v3.Subset.LbSubsetSelector<a class="headerlink" href="#extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector" title="Link to this heading"></a></h2>
<p><a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.32.2/api/envoy/extensions/load_balancing_policies/subset/v3/subset.proto#L86">[extensions.load_balancing_policies.subset.v3.Subset.LbSubsetSelector proto]</a></p>
<p>Specifications for subsets.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;keys&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">  </span><span class="nt">&quot;single_host_per_subset&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">...</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;fallback_policy&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">...</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;fallback_keys_subset&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="p">}</span>
</pre></div>
</div>
<dl class="simple" id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-keys">
<dt>keys</dt><dd><p>(<strong>repeated</strong> <a class="reference external" href="https://developers.google.com/protocol-buffers/docs/proto#scalar">string</a>) List of keys to match with the weighted cluster metadata.</p>
</dd>
</dl>
<dl id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-single-host-per-subset">
<dt>single_host_per_subset</dt><dd><p>(<a class="reference external" href="https://developers.google.com/protocol-buffers/docs/proto#scalar">bool</a>) Selects a mode of operation in which each subset has only one host. This mode uses the same rules for
choosing a host, but updating hosts is faster, especially for large numbers of hosts.</p>
<p>If a match is found to a host, that host will be used regardless of priority levels.</p>
<p>When this mode is enabled, configurations that contain more than one host with the same metadata value for the single key in <code class="docutils literal notranslate"><span class="pre">keys</span></code>
will use only one of the hosts with the given key; no requests will be routed to the others. The cluster gauge
<a class="reference internal" href="../../../../../configuration/upstream/cluster_manager/cluster_stats.html#config-cluster-manager-cluster-stats-subset-lb"><span class="std std-ref">lb_subsets_single_host_per_subset_duplicate</span></a> indicates how many duplicates are
present in the current configuration.</p>
</dd>
</dl>
<dl class="simple" id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-fallback-policy">
<dt>fallback_policy</dt><dd><p>(<a class="reference internal" href="#envoy-v3-api-enum-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-lbsubsetselectorfallbackpolicy"><span class="std std-ref">extensions.load_balancing_policies.subset.v3.Subset.LbSubsetSelector.LbSubsetSelectorFallbackPolicy</span></a>) The behavior used when no endpoint subset matches the selected route’s
metadata.</p>
</dd>
</dl>
<dl class="simple" id="envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-fallback-keys-subset">
<dt>fallback_keys_subset</dt><dd><p>(<strong>repeated</strong> <a class="reference external" href="https://developers.google.com/protocol-buffers/docs/proto#scalar">string</a>) Subset of
<a class="reference internal" href="#envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-keys"><span class="std std-ref">keys</span></a> used by
<a class="reference internal" href="#envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-lbsubsetselectorfallbackpolicy-keys-subset"><span class="std std-ref">KEYS_SUBSET</span></a>
fallback policy.
It has to be a non empty list if KEYS_SUBSET fallback policy is selected.
For any other fallback policy the parameter is not used and should not be set.
Only values also present in
<a class="reference internal" href="#envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-keys"><span class="std std-ref">keys</span></a> are allowed, but
<code class="docutils literal notranslate"><span class="pre">fallback_keys_subset</span></code> cannot be equal to <code class="docutils literal notranslate"><span class="pre">keys</span></code>.</p>
</dd>
</dl>
</section>
<section id="enum-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-lbsubsetselectorfallbackpolicy">
<span id="envoy-v3-api-enum-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-lbsubsetselectorfallbackpolicy"></span><h2>Enum extensions.load_balancing_policies.subset.v3.Subset.LbSubsetSelector.LbSubsetSelectorFallbackPolicy<a class="headerlink" href="#enum-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-lbsubsetselectorfallbackpolicy" title="Link to this heading"></a></h2>
<p><a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.32.2/api/envoy/extensions/load_balancing_policies/subset/v3/subset.proto#L88">[extensions.load_balancing_policies.subset.v3.Subset.LbSubsetSelector.LbSubsetSelectorFallbackPolicy proto]</a></p>
<p>Allows to override top level fallback policy per selector.</p>
<dl class="simple" id="envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-lbsubsetselectorfallbackpolicy-not-defined">
<dt>NOT_DEFINED</dt><dd><p><em>(DEFAULT)</em> ⁣If NOT_DEFINED top level config fallback policy is used instead.</p>
</dd>
</dl>
<dl class="simple" id="envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-lbsubsetselectorfallbackpolicy-no-fallback">
<dt>NO_FALLBACK</dt><dd><p>⁣If NO_FALLBACK is selected, a result equivalent to no healthy hosts is reported.</p>
</dd>
</dl>
<dl class="simple" id="envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-lbsubsetselectorfallbackpolicy-any-endpoint">
<dt>ANY_ENDPOINT</dt><dd><p>⁣If ANY_ENDPOINT is selected, any cluster endpoint may be returned
(subject to policy, health checks, etc).</p>
</dd>
</dl>
<dl class="simple" id="envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-lbsubsetselectorfallbackpolicy-default-subset">
<dt>DEFAULT_SUBSET</dt><dd><p>⁣If DEFAULT_SUBSET is selected, load balancing is performed over the
endpoints matching the values from the default_subset field.</p>
</dd>
</dl>
<dl class="simple" id="envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-lbsubsetselectorfallbackpolicy-keys-subset">
<dt>KEYS_SUBSET</dt><dd><p>⁣If KEYS_SUBSET is selected, subset selector matching is performed again with metadata
keys reduced to
<a class="reference internal" href="#envoy-v3-api-field-extensions-load-balancing-policies-subset-v3-subset-lbsubsetselector-fallback-keys-subset"><span class="std std-ref">fallback_keys_subset</span></a>.
It allows for a fallback to a different, less specific selector if some of the keys of
the selector are considered optional.</p>
</dd>
</dl>
</section>
<section id="enum-extensions-load-balancing-policies-subset-v3-subset-lbsubsetfallbackpolicy">
<span id="envoy-v3-api-enum-extensions-load-balancing-policies-subset-v3-subset-lbsubsetfallbackpolicy"></span><h2>Enum extensions.load_balancing_policies.subset.v3.Subset.LbSubsetFallbackPolicy<a class="headerlink" href="#enum-extensions-load-balancing-policies-subset-v3-subset-lbsubsetfallbackpolicy" title="Link to this heading"></a></h2>
<p><a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.32.2/api/envoy/extensions/load_balancing_policies/subset/v3/subset.proto#L33">[extensions.load_balancing_policies.subset.v3.Subset.LbSubsetFallbackPolicy proto]</a></p>
<p>If NO_FALLBACK is selected, a result
equivalent to no healthy hosts is reported. If ANY_ENDPOINT is selected,
any cluster endpoint may be returned (subject to policy, health checks,
etc). If DEFAULT_SUBSET is selected, load balancing is performed over the
endpoints matching the values from the default_subset field.</p>
<dl class="simple" id="envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetfallbackpolicy-no-fallback">
<dt>NO_FALLBACK</dt><dd><p><em>(DEFAULT)</em> ⁣</p>
</dd>
</dl>
<dl class="simple" id="envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetfallbackpolicy-any-endpoint">
<dt>ANY_ENDPOINT</dt><dd><p>⁣</p>
</dd>
</dl>
<dl class="simple" id="envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetfallbackpolicy-default-subset">
<dt>DEFAULT_SUBSET</dt><dd><p>⁣</p>
</dd>
</dl>
</section>
<section id="enum-extensions-load-balancing-policies-subset-v3-subset-lbsubsetmetadatafallbackpolicy">
<span id="envoy-v3-api-enum-extensions-load-balancing-policies-subset-v3-subset-lbsubsetmetadatafallbackpolicy"></span><h2>Enum extensions.load_balancing_policies.subset.v3.Subset.LbSubsetMetadataFallbackPolicy<a class="headerlink" href="#enum-extensions-load-balancing-policies-subset-v3-subset-lbsubsetmetadatafallbackpolicy" title="Link to this heading"></a></h2>
<p><a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.32.2/api/envoy/extensions/load_balancing_policies/subset/v3/subset.proto#L39">[extensions.load_balancing_policies.subset.v3.Subset.LbSubsetMetadataFallbackPolicy proto]</a></p>
<dl class="simple" id="envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetmetadatafallbackpolicy-metadata-no-fallback">
<dt>METADATA_NO_FALLBACK</dt><dd><p><em>(DEFAULT)</em> ⁣No fallback. Route metadata will be used as-is.</p>
</dd>
</dl>
<dl id="envoy-v3-api-enum-value-extensions-load-balancing-policies-subset-v3-subset-lbsubsetmetadatafallbackpolicy-fallback-list">
<dt>FALLBACK_LIST</dt><dd><p>⁣A special metadata key <code class="docutils literal notranslate"><span class="pre">fallback_list</span></code> will be used to provide variants of metadata to try.
Value of <code class="docutils literal notranslate"><span class="pre">fallback_list</span></code> key has to be a list. Every list element has to be a struct - it will
be merged with route metadata, overriding keys that appear in both places.
<code class="docutils literal notranslate"><span class="pre">fallback_list</span></code> entries will be used in order until a host is found.</p>
<p><code class="docutils literal notranslate"><span class="pre">fallback_list</span></code> key itself is removed from metadata before subset load balancing is performed.</p>
<p>Example:</p>
<p>for metadata:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
<span class="nt">fallback_list</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.0</span>
<span class="w">    </span><span class="nt">hardware</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c64</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hardware</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c32</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.0</span>
</pre></div>
</div>
<p>at first, metadata:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;hardware&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;c64&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>will be used for load balancing. If no host is found, metadata:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;hardware&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;c32&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>is next to try. If it still results in no host, finally metadata:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3.0&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>is used.</p>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../round_robin/v3/round_robin.proto.html" class="btn btn-neutral float-left" title="Round Robin Load Balancing Policy (proto)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../../../config/cluster_specifier/cluster_specifier.html" class="btn btn-neutral float-right" title="Cluster specifier" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2024, Envoy Project Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>