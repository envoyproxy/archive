

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kafka Mesh filter &mdash; envoy tag-v1.33.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d7d10ef0" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/envoy.css?v=3ec0219e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=4da122e5" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=505370fb"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=db7b0edf"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Local rate limit" href="local_rate_limit_filter.html" />
    <link rel="prev" title="Kafka Broker filter" href="kafka_broker_filter.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../listeners.html">Listeners</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../stats.html">Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../runtime.html">Runtime</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listener_filters/listener_filters.html">Listener filters</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="network_filters.html">Network filters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="client_ssl_auth_filter.html">Client TLS authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="connection_limit_filter.html">Connection Limit Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="direct_response_filter.html">Direct response</a></li>
<li class="toctree-l4"><a class="reference internal" href="dubbo_proxy_filter.html">Dubbo proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="echo_filter.html">Echo</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l4"><a class="reference internal" href="generic_proxy_filter.html">Generic proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="golang_filter.html">Golang</a></li>
<li class="toctree-l4"><a class="reference internal" href="kafka_broker_filter.html">Kafka Broker filter</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Kafka Mesh filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="local_rate_limit_filter.html">Local rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="mongo_proxy_filter.html">Mongo proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="mysql_proxy_filter.html">MySQL proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="postgres_proxy_filter.html">Postgres proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_filter.html">Rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="rbac_filter.html">Role Based Access Control (RBAC) Network Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="redis_proxy_filter.html">Redis proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="rocketmq_proxy_filter.html">RocketMQ proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="set_filter_state.html">Set-Filter-State Network Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="sni_cluster_filter.html">Upstream Cluster from SNI</a></li>
<li class="toctree-l4"><a class="reference internal" href="sni_dynamic_forward_proxy_filter.html">SNI dynamic forward proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="tcp_proxy_filter.html">TCP proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="thrift_proxy_filter.html">Thrift proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="wasm_filter.html">Wasm Network Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="zookeeper_proxy_filter.html">ZooKeeper proxy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../udp_filters/udp_filters.html">UDP listener filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lds.html">Listener discovery service (LDS)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../http/http.html">HTTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../configuration.html">Configuration reference</a></li>
          <li class="breadcrumb-item"><a href="../listeners.html">Listeners</a></li>
          <li class="breadcrumb-item"><a href="network_filters.html">Network filters</a></li>
      <li class="breadcrumb-item active">Kafka Mesh filter</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/configuration/listeners/network_filters/kafka_mesh_filter.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="kafka-mesh-filter">
<span id="config-network-filters-kafka-mesh"></span><h1>Kafka Mesh filter<a class="headerlink" href="#kafka-mesh-filter" title="Link to this heading">ÔÉÅ</a></h1>
<p>The Apache Kafka mesh filter provides a facade for <a class="reference external" href="https://kafka.apache.org/">Apache Kafka</a>
clusters.</p>
<p>It allows for processing of Produce (producer) and Fetch (consumer) requests sent by downstream
clients.</p>
<p>The requests received by this filter instance can be forwarded to one of multiple clusters,
depending on the configured forwarding rules.</p>
<p>Corresponding message versions from Kafka 3.8.0 are supported.</p>
<ul class="simple">
<li><p>This filter should be configured with the type URL <code class="docutils literal notranslate"><span class="pre">type.googleapis.com/envoy.extensions.filters.network.kafka_mesh.v3alpha.KafkaMesh</span></code>.</p></li>
<li><p><a class="reference internal" href="../../../api-v3/extensions/filters/network/kafka_mesh/v3alpha/kafka_mesh.proto.html#envoy-v3-api-msg-extensions-filters-network-kafka-mesh-v3alpha-kafkamesh"><span class="std std-ref">v3 API reference</span></a></p></li>
</ul>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The Kafka mesh filter is only included in <a class="reference internal" href="../../../start/install.html#install-contrib"><span class="std std-ref">contrib images</span></a></p>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The kafka_mesh filter is experimental and is currently under active development.
Capabilities will be expanded over time and the configuration structures are likely to change.</p>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The kafka_mesh filter is does not work on Windows (the blocker is getting librdkafka compiled).</p>
</div>
<section id="configuration">
<span id="config-network-filters-kafka-mesh-config"></span><h2>Configuration<a class="headerlink" href="#configuration" title="Link to this heading">ÔÉÅ</a></h2>
<p>Below example shows us typical filter configuration that proxies 3 Kafka clusters.
Clients are going to connect to ‚Äò127.0.0.1:19092‚Äô, and their messages are going to be distributed
to cluster depending on topic names.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">listeners</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">address</span><span class="p">:</span>
<span class="w">    </span><span class="nt">socket_address</span><span class="p">:</span>
<span class="w">      </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span><span class="w"> </span><span class="c1"># Host that Kafka clients should connect to.</span>
<span class="w">      </span><span class="nt">port_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">19092</span><span class="w">  </span><span class="c1"># Port that Kafka clients should connect to.</span>
<span class="w">  </span><span class="nt">filter_chains</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.filters.network.kafka_mesh</span>
<span class="w">      </span><span class="nt">typed_config</span><span class="p">:</span>
<span class="w">        </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.network.kafka_mesh.v3alpha.KafkaMesh</span>
<span class="w">        </span><span class="nt">advertised_host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.1&quot;</span>
<span class="w">        </span><span class="nt">advertised_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">19092</span>
<span class="w">        </span><span class="nt">upstream_clusters</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cluster_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kafka_c1</span>
<span class="w">          </span><span class="nt">bootstrap_servers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster1_node1:9092,cluster1_node2:9092,cluster1_node3:9092</span>
<span class="w">          </span><span class="nt">partition_count</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cluster_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kafka_c2</span>
<span class="w">          </span><span class="nt">bootstrap_servers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster2_node1:9092,cluster2_node2:9092,cluster2_node3:9092</span>
<span class="w">          </span><span class="nt">partition_count</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cluster_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kafka_c3</span>
<span class="w">          </span><span class="nt">bootstrap_servers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster3_node1:9092,cluster3_node2:9092</span>
<span class="w">          </span><span class="nt">partition_count</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">          </span><span class="nt">producer_config</span><span class="p">:</span>
<span class="w">            </span><span class="nt">acks</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">            </span><span class="nt">linger.ms</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;500&quot;</span>
<span class="w">          </span><span class="nt">consumer_config</span><span class="p">:</span>
<span class="w">            </span><span class="nt">client.id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;my-envoy-consumer&quot;</span>
<span class="w">        </span><span class="nt">forwarding_rules</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target_cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kafka_c1</span>
<span class="w">          </span><span class="nt">topic_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apples</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target_cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kafka_c2</span>
<span class="w">          </span><span class="nt">topic_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bananas</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target_cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kafka_c3</span>
<span class="w">          </span><span class="nt">topic_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cherries</span>
</pre></div>
</div>
<p>It should be noted that Kafka broker filter can be inserted before Kafka mesh filter in the filter
chain to capture the request processing metrics.</p>
</section>
<section id="notes">
<span id="config-network-filters-kafka-mesh-notes"></span><h2>Notes<a class="headerlink" href="#notes" title="Link to this heading">ÔÉÅ</a></h2>
<ol class="arabic simple">
<li><p>The records are being sent/received using embedded
<a class="reference external" href="https://github.com/confluentinc/librdkafka">librdkafka</a> producers/consumers.</p></li>
<li><p>librdkafka was compiled without ssl, lz4, gssapi, so related custom config options are
not supported.</p></li>
<li><p>Invalid custom configs are not found at startup (only when appropriate producers or consumers
are being initialised). Requests that would have referenced these clusters are going to close
connection and fail.</p></li>
<li><p>Requests that reference to topics that do not match any of the rules are going to close
connection and fail. This usually should not happen (clients request metadata first, and they
should then fail with ‚Äòno broker available‚Äô first), but is possible if someone tailors binary
payloads over the connection.</p></li>
</ol>
</section>
<section id="producer-proxy">
<h2>Producer proxy<a class="headerlink" href="#producer-proxy" title="Link to this heading">ÔÉÅ</a></h2>
<ol class="arabic simple">
<li><p>The embedded librdkafka producers that are pointing at upstream Kafka clusters are created
per Envoy worker thread (so the throughput can be increased with <cite>‚Äìconcurrency</cite> option,
allowing for requests to be processed by a larger number of producers).</p></li>
<li><p>Only ProduceRequests with version 2 are supported (what means very old producers like 0.8
are not going to be supported).</p></li>
<li><p>Python producers need to set API version of at least 1.0.0, so that the produce requests
they send are going to have records with magic equal to 2.</p></li>
<li><p>Downstream handling of Kafka producer ‚Äòacks‚Äô property is delegated to upstream client.
E.g. if upstream client is configured to use acks=0 then the response is going to be sent
to downstream client as soon as possible (even if they had non-zero acks!).</p></li>
<li><p>As the filter splits single producer requests into separate records, it‚Äôs possible that delivery
of only some of these records fails. In that case, the response returned to upstream client is
a failure, however it is possible some of the records have been appended in the target cluster.</p></li>
<li><p>Because of the splitting mentioned above, records are not necessarily appended one after another
(as they do not get sent as single request to upstream). Users that want to avoid this scenario
might want to take a look into downstream producer configs: ‚Äòlinger.ms‚Äô and ‚Äòbatch.size‚Äô.</p></li>
</ol>
</section>
<section id="consumer-proxy">
<h2>Consumer proxy<a class="headerlink" href="#consumer-proxy" title="Link to this heading">ÔÉÅ</a></h2>
<ol class="arabic simple">
<li><p>Currently the consumer proxy supports only stateful proxying - Envoy uses upstream-pointing
librdkafka consumers to receive the records, and does that only when more data is requested.</p></li>
<li><p>Users might want to take a look consumers‚Äô config property <em>group.id</em> to manage the consumers‚Äô
offset committing behaviour (what is meaningful across Envoy restarts).</p></li>
<li><p>When requesting consumer position, the response always contains offset = 0
(see <em>list_offsets.cc</em>).</p></li>
<li><p>Record offset information is provided, but record batch offset delta is not -
it has been observed that the Apache Kafka Java client is not going to update its position
despite receiving records (see <em>fetch_record_converter.cc</em>).</p></li>
<li><p>The Fetch response is sent downstream if it has collected at least 3 records (see <em>fetch.cc</em>).
The data about requested bytes etc. in the request is ignored by the current implementation.</p></li>
<li><p>The Fetch response is sent after it is considered to be fulfilled (see above) or the hardcoded
timeout of 5 seconds passes (see <em>fetch.cc</em>). Timeout specified by request is ignored.</p></li>
<li><p>The consumers are going to poll records from topics as long as there are incoming requests for
these topics, without considering partitions.
Users are encouraged to make sure all partitions are being consumed from to avoid a situation
when e.g. we are only fetching records from partition 0, but the proxy receives records
for partition 0 (which are sent downstream) and partition 1 (which are kept in memory until
someone shows interest in them).</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="kafka_broker_filter.html" class="btn btn-neutral float-left" title="Kafka Broker filter" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="local_rate_limit_filter.html" class="btn btn-neutral float-right" title="Local rate limit" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2025, Envoy Project Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>