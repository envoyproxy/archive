

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lua &mdash; envoy tag-v1.33.11 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d7d10ef0" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/envoy.css?v=3ec0219e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=4da122e5" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5829c46c"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=db7b0edf"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="OAuth2" href="oauth2_filter.html" />
    <link rel="prev" title="Local rate limit" href="local_rate_limit_filter.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../listeners/listeners.html">Listeners</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../http.html">HTTP</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../http_conn_man/http_conn_man.html">HTTP connection manager</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="http_filters.html">HTTP filters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="adaptive_concurrency_filter.html">Adaptive Concurrency</a></li>
<li class="toctree-l4"><a class="reference internal" href="admission_control_filter.html">Admission Control</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_lambda_filter.html">AWS Lambda</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_key_auth_filter.html">API key auth</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_request_signing_filter.html">AWS Request Signing</a></li>
<li class="toctree-l4"><a class="reference internal" href="bandwidth_limit_filter.html">Bandwidth limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="basic_auth_filter.html">Basic Auth</a></li>
<li class="toctree-l4"><a class="reference internal" href="buffer_filter.html">Buffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="cache_filter.html">Cache filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="cdn_loop_filter.html">CDN-Loop header</a></li>
<li class="toctree-l4"><a class="reference internal" href="checksum_filter.html">Checksum</a></li>
<li class="toctree-l4"><a class="reference internal" href="compressor_filter.html">Compressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="composite_filter.html">Composite Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="connect_grpc_bridge_filter.html">Connect-gRPC Bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="cors_filter.html">CORS</a></li>
<li class="toctree-l4"><a class="reference internal" href="credential_injector_filter.html">Credential injector</a></li>
<li class="toctree-l4"><a class="reference internal" href="csrf_filter.html">CSRF</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom_response_filter.html">Custom Response Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="decompressor_filter.html">Decompressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic_forward_proxy_filter.html">Dynamic forward proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamodb_filter.html">DynamoDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_proc_filter.html">External Processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="fault_filter.html">Fault Injection</a></li>
<li class="toctree-l4"><a class="reference internal" href="file_system_buffer_filter.html">File System Buffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="gcp_authn_filter.html">GCP Authentication Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="geoip_filter.html">IP Geolocation Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="golang_filter.html">Golang</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_field_extraction_filter.html">gRPC Field Extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_bridge_filter.html">gRPC HTTP/1.1 bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_reverse_bridge_filter.html">gRPC HTTP/1.1 reverse bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_json_reverse_transcoder_filter.html">gRPC-JSON reverse transcoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_json_transcoder_filter.html">gRPC-JSON transcoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_stats_filter.html">gRPC Statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_web_filter.html">gRPC-Web</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_mutation_filter.html">Header Mutation</a></li>
<li class="toctree-l4"><a class="reference internal" href="health_check_filter.html">Health check</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_to_metadata_filter.html">Envoy Header-To-Metadata Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="ip_tagging_filter.html">IP Tagging</a></li>
<li class="toctree-l4"><a class="reference internal" href="json_to_metadata_filter.html">Envoy Json-To-Metadata Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="jwt_authn_filter.html">JWT Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="kill_request_filter.html">Kill Request</a></li>
<li class="toctree-l4"><a class="reference internal" href="language_filter.html">Language</a></li>
<li class="toctree-l4"><a class="reference internal" href="local_rate_limit_filter.html">Local rate limit</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="oauth2_filter.html">OAuth2</a></li>
<li class="toctree-l4"><a class="reference internal" href="on_demand_updates_filter.html">On-demand VHDS, S/RDS and CDS Updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="original_src_filter.html">Original Source</a></li>
<li class="toctree-l4"><a class="reference internal" href="proto_message_extraction_filter.html">Proto Message Extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_filter.html">Rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_quota_filter.html">Rate Limit Quota (Work-In-Progress)</a></li>
<li class="toctree-l4"><a class="reference internal" href="rbac_filter.html">Role Based Access Control (RBAC) Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="router_filter.html">Router</a></li>
<li class="toctree-l4"><a class="reference internal" href="set_filter_state.html">Set-Filter-State HTTP Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="set_metadata_filter.html">Set Metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="squash_filter.html">Squash</a></li>
<li class="toctree-l4"><a class="reference internal" href="stateful_session_filter.html">Stateful session</a></li>
<li class="toctree-l4"><a class="reference internal" href="sxg_filter.html">SXG</a></li>
<li class="toctree-l4"><a class="reference internal" href="tap_filter.html">Tap</a></li>
<li class="toctree-l4"><a class="reference internal" href="thrift_to_metadata_filter.html">Envoy Thrift-To-Metadata Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="upstream_codec_filter.html">Upstream Codec</a></li>
<li class="toctree-l4"><a class="reference internal" href="wasm_filter.html">Wasm</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../caches/caches.html">HTTP caches</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cluster_specifier/cluster_specifier.html">HTTP cluster specifier</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../configuration.html">Configuration reference</a></li>
          <li class="breadcrumb-item"><a href="../http.html">HTTP</a></li>
          <li class="breadcrumb-item"><a href="http_filters.html">HTTP filters</a></li>
      <li class="breadcrumb-item active">Lua</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/configuration/http/http_filters/lua_filter.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="lua">
<span id="config-http-filters-lua"></span><h1>Lua<a class="headerlink" href="#lua" title="Link to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>The HTTP Lua filter allows <a class="reference external" href="https://www.lua.org/">Lua</a> scripts to be run during both the request
and response flows. <a class="reference external" href="https://luajit.org/">LuaJIT</a> is used as the runtime. Because of this, the
supported Lua version is mostly 5.1 with some 5.2 features. See the <a class="reference external" href="https://luajit.org/extensions.html">LuaJIT documentation</a> for more details.</p>
<p>The design of the filter and Lua support at a high level is as follows:</p>
<ul class="simple">
<li><p>All Lua environments are <a class="reference internal" href="../../../intro/arch_overview/intro/threading_model.html#arch-overview-threading"><span class="std std-ref">per worker thread</span></a>. This means that
there is no truly global data. Any globals created and populated at load time will be visible
from each worker thread in isolation. True global support may be added via an API in the future.</p></li>
<li><p>All scripts are run as coroutines. This means that they are written in a synchronous style even
though they may perform complex asynchronous tasks. This makes the scripts substantially easier
to write. All network/async processing is performed by Envoy via a set of APIs. Envoy will
suspend execution of the script as appropriate and resume it when async tasks are complete.</p></li>
<li><p><strong>Do not perform blocking operations from scripts.</strong> It is critical for performance that
Envoy APIs are used for all IO.</p></li>
</ul>
</section>
<section id="currently-supported-high-level-features">
<h2>Currently supported high level features<a class="headerlink" href="#currently-supported-high-level-features" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is expected that this list will expand over time as the filter is used in production.
The API surface has been kept small on purpose. The goal is to make scripts extremely simple and
safe to write. Very complex or high performance use cases are assumed to use the native C++ filter
API.</p>
</div>
<ul class="simple">
<li><p>Inspection of headers, body, and trailers while streaming in either the request flow, response
flow, or both.</p></li>
<li><p>Modification of headers and trailers.</p></li>
<li><p>Blocking and buffering the full request/response body for inspection.</p></li>
<li><p>Performing an outbound async HTTP call to an upstream host. Such a call can be performed while
buffering body data so that when the call completes upstream headers can be modified.</p></li>
<li><p>Performing a direct response and skipping further filter iteration. For example, a script
could make an upstream HTTP call for authentication, and then directly respond with a 403
response code.</p></li>
</ul>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>This filter should be configured with the type URL <code class="docutils literal notranslate"><span class="pre">type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua</span></code>.</p></li>
<li><p><a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-msg-extensions-filters-http-lua-v3-lua"><span class="std std-ref">v3 API reference</span></a></p></li>
</ul>
<p>A simple example of configuring Lua HTTP filter that contains only <a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-field-extensions-filters-http-lua-v3-lua-default-source-code"><span class="std std-ref">default source code</span></a> is as follow:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.lua</span>
<span class="nt">typed_config</span><span class="p">:</span>
<span class="w">  </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua</span>
<span class="w">  </span><span class="nt">default_source_code</span><span class="p">:</span>
<span class="w">    </span><span class="nt">inline_string</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">-- Called on the request path.</span>
<span class="w">      </span><span class="no">function envoy_on_request(request_handle)</span>
<span class="w">        </span><span class="no">-- Do something.</span>
<span class="w">      </span><span class="no">end</span>
<span class="w">      </span><span class="no">-- Called on the response path.</span>
<span class="w">      </span><span class="no">function envoy_on_response(response_handle)</span>
<span class="w">        </span><span class="no">-- Do something.</span>
<span class="w">      </span><span class="no">end</span>
</pre></div>
</div>
<p>By default, Lua script defined in <code class="docutils literal notranslate"><span class="pre">default_source_code</span></code> will be treated as a <code class="docutils literal notranslate"><span class="pre">default</span></code> script. Envoy will
execute it for every HTTP request. This <code class="docutils literal notranslate"><span class="pre">default</span></code> script is optional.</p>
</section>
<section id="per-route-configuration">
<h2>Per-Route Configuration<a class="headerlink" href="#per-route-configuration" title="Link to this heading"></a></h2>
<p>The Lua HTTP filter also can be disabled or overridden on a per-route basis by providing a
<a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-msg-extensions-filters-http-lua-v3-luaperroute"><span class="std std-ref">LuaPerRoute</span></a> configuration
on the virtual host, route, or weighted cluster.</p>
<p>LuaPerRoute provides two ways of overriding the <code class="docutils literal notranslate"><span class="pre">default</span></code> Lua script:</p>
<ul class="simple">
<li><p>By providing a name reference to the defined <a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-field-extensions-filters-http-lua-v3-lua-source-codes"><span class="std std-ref">named Lua source codes map</span></a>.</p></li>
<li><p>By providing inline <a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-field-extensions-filters-http-lua-v3-luaperroute-source-code"><span class="std std-ref">source code</span></a> (This allows the
code to be sent through RDS).</p></li>
</ul>
<p>As a concrete example, given the following Lua filter configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.lua</span>
<span class="nt">typed_config</span><span class="p">:</span>
<span class="w">  </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua</span>
<span class="w">  </span><span class="nt">default_source_code</span><span class="p">:</span>
<span class="w">    </span><span class="nt">inline_string</span><span class="p">:</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">function envoy_on_request(request_handle)</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">-- do something</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">end</span>
<span class="w">  </span><span class="nt">source_codes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">hello.lua</span><span class="p">:</span>
<span class="w">      </span><span class="nt">inline_string</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">function envoy_on_request(request_handle)</span>
<span class="w">          </span><span class="no">request_handle:logInfo(&quot;Hello World.&quot;)</span>
<span class="w">        </span><span class="no">end</span>
<span class="w">    </span><span class="nt">bye.lua</span><span class="p">:</span>
<span class="w">      </span><span class="nt">inline_string</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">function envoy_on_response(response_handle)</span>
<span class="w">          </span><span class="no">response_handle:logInfo(&quot;Bye Bye.&quot;)</span>
<span class="w">        </span><span class="no">end</span>
</pre></div>
</div>
<p>The HTTP Lua filter can be disabled on some virtual host, route, or weighted cluster by the
<a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-msg-extensions-filters-http-lua-v3-luaperroute"><span class="std std-ref">LuaPerRoute</span></a> configuration as
follow:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">typed_per_filter_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">envoy.filters.http.lua</span><span class="p">:</span>
<span class="w">    </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.lua.v3.LuaPerRoute</span>
<span class="w">    </span><span class="nt">disabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>We can also refer to a Lua script in the filter configuration by specifying a name in LuaPerRoute.
The <code class="docutils literal notranslate"><span class="pre">default</span></code> Lua script will be overridden by the referenced script:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">typed_per_filter_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">envoy.filters.http.lua</span><span class="p">:</span>
<span class="w">    </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.lua.v3.LuaPerRoute</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello.lua</span>
</pre></div>
</div>
<p>Or we can define a new Lua script in the LuaPerRoute configuration directly to override the <code class="docutils literal notranslate"><span class="pre">default</span></code>
Lua script as follows:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">typed_per_filter_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">envoy.filters.http.lua</span><span class="p">:</span>
<span class="w">    </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.lua.v3.LuaPerRoute</span>
<span class="w">    </span><span class="nt">source_code</span><span class="p">:</span>
<span class="w">      </span><span class="nt">inline_string</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">function envoy_on_response(response_handle)</span>
<span class="w">          </span><span class="no">response_handle:logInfo(&quot;Goodbye.&quot;)</span>
<span class="w">        </span><span class="no">end</span>
</pre></div>
</div>
</section>
<section id="statistics">
<h2>Statistics<a class="headerlink" href="#statistics" title="Link to this heading"></a></h2>
<p id="config-http-filters-lua-stats">The lua filter outputs statistics in the <code class="docutils literal notranslate"><span class="pre">.lua.</span></code> namespace by default. When
there are multiple lua filters configured in a filter chain, stats from
individual filter instance/script can be tracked by providing a per filter
<a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-field-extensions-filters-http-lua-v3-lua-stat-prefix"><span class="std std-ref">stat prefix</span></a>.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25.0%" />
<col style="width: 25.0%" />
<col style="width: 50.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>error</p></td>
<td><p>Counter</p></td>
<td><p>Total script execution errors.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="script-examples">
<h2>Script examples<a class="headerlink" href="#script-examples" title="Link to this heading"></a></h2>
<p>This section provides some concrete examples of Lua scripts as a more gentle introduction and quick
start. Please refer to the <a class="reference internal" href="#config-http-filters-lua-stream-handle-api"><span class="std std-ref">stream handle API</span></a> for
more details on the supported API.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Called on the request path.</span>
<span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="c1">-- Wait for the entire request body and add a request header with the body size.</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;request_body_size&quot;</span><span class="p">,</span> <span class="n">request_handle</span><span class="p">:</span><span class="n">body</span><span class="p">():</span><span class="n">length</span><span class="p">())</span>
<span class="kr">end</span>

<span class="c1">-- Called on the response path.</span>
<span class="kr">function</span> <span class="nf">envoy_on_response</span><span class="p">(</span><span class="n">response_handle</span><span class="p">)</span>
  <span class="c1">-- Wait for the entire response body and add a response header with the body size.</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;response_body_size&quot;</span><span class="p">,</span> <span class="n">response_handle</span><span class="p">:</span><span class="n">body</span><span class="p">():</span><span class="n">length</span><span class="p">())</span>
  <span class="c1">-- Remove a response header named &#39;foo&#39;</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="c1">-- Make an HTTP call to an upstream host with the following headers, body, and timeout.</span>
  <span class="kd">local</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">request_handle</span><span class="p">:</span><span class="n">httpCall</span><span class="p">(</span>
  <span class="s2">&quot;lua_cluster&quot;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="p">[</span><span class="s2">&quot;:method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;:path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;:authority&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;lua_cluster&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;hello world&quot;</span><span class="p">,</span>
  <span class="mi">5000</span><span class="p">)</span>

  <span class="c1">-- Add information from the HTTP call into the headers that are about to be sent to the next</span>
  <span class="c1">-- filter in the filter chain.</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;upstream_foo&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">])</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;upstream_body_size&quot;</span><span class="p">,</span> <span class="o">#</span><span class="n">body</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="c1">-- Make an HTTP call.</span>
  <span class="kd">local</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">request_handle</span><span class="p">:</span><span class="n">httpCall</span><span class="p">(</span>
  <span class="s2">&quot;lua_cluster&quot;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="p">[</span><span class="s2">&quot;:method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;:path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;:authority&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;lua_cluster&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;set-cookie&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;lang=lua; Path=/&quot;</span><span class="p">,</span> <span class="s2">&quot;type=binding; Path=/&quot;</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;hello world&quot;</span><span class="p">,</span>
  <span class="mi">5000</span><span class="p">)</span>

  <span class="c1">-- Response directly and set a header from the HTTP call. No further filter iteration</span>
  <span class="c1">-- occurs.</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">respond</span><span class="p">(</span>
    <span class="p">{[</span><span class="s2">&quot;:status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;403&quot;</span><span class="p">,</span>
     <span class="p">[</span><span class="s2">&quot;upstream_foo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]},</span>
    <span class="s2">&quot;nope&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="c1">-- Log information about the request</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="s2">&quot;Authority: &quot;</span><span class="o">..</span><span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;:authority&quot;</span><span class="p">))</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="s2">&quot;Method: &quot;</span><span class="o">..</span><span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;:method&quot;</span><span class="p">))</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="s2">&quot;Path: &quot;</span><span class="o">..</span><span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;:path&quot;</span><span class="p">))</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">envoy_on_response</span><span class="p">(</span><span class="n">response_handle</span><span class="p">)</span>
  <span class="c1">-- Log response status code</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="s2">&quot;Status: &quot;</span><span class="o">..</span><span class="n">response_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;:status&quot;</span><span class="p">))</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>A common use-case is to rewrite upstream response body, for example: an upstream sends non-2xx
response with JSON data, but the application requires HTML page to be sent to browsers.</p>
<p>There are two ways of doing this, the first one is via the <code class="docutils literal notranslate"><span class="pre">body()</span></code> API.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_response</span><span class="p">(</span><span class="n">response_handle</span><span class="p">)</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">body</span><span class="p">():</span><span class="n">setBytes</span><span class="p">(</span><span class="s2">&quot;&lt;html&gt;&lt;b&gt;Not Found&lt;b&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>Or, through <code class="docutils literal notranslate"><span class="pre">bodyChunks()</span></code> API, which let Envoy to skip buffering the upstream response data.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_response</span><span class="p">(</span><span class="n">response_handle</span><span class="p">)</span>

  <span class="c1">-- Sets the content-type.</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>

  <span class="kd">local</span> <span class="n">last</span>
  <span class="kr">for</span> <span class="n">chunk</span> <span class="kr">in</span> <span class="n">response_handle</span><span class="p">:</span><span class="n">bodyChunks</span><span class="p">()</span> <span class="kr">do</span>
    <span class="c1">-- Clears each received chunk.</span>
    <span class="n">chunk</span><span class="p">:</span><span class="n">setBytes</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">chunk</span>
  <span class="kr">end</span>

  <span class="n">last</span><span class="p">:</span><span class="n">setBytes</span><span class="p">(</span><span class="s2">&quot;&lt;html&gt;&lt;b&gt;Not Found&lt;b&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
</section>
<section id="complete-example">
<span id="config-http-filters-lua-stream-handle-api"></span><h2>Complete example<a class="headerlink" href="#complete-example" title="Link to this heading"></a></h2>
<p>A complete example using Docker is available in <a class="reference external" href="https://github.com/envoyproxy/examples/tree/main/lua">here</a>.</p>
</section>
<section id="stream-handle-api">
<h2>Stream handle API<a class="headerlink" href="#stream-handle-api" title="Link to this heading"></a></h2>
<p>When Envoy loads the script in the configuration, it looks for two global functions that the
script defines:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">envoy_on_response</span><span class="p">(</span><span class="n">response_handle</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>A script can define either or both of these functions. During the request path, Envoy will
run <em>envoy_on_request</em> as a coroutine, passing a handle to the request API. During the
response path, Envoy will run <em>envoy_on_response</em> as a coroutine, passing handle to the
response API.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>It is critical that all interaction with Envoy occur through the passed stream handle. The stream
handle should not be assigned to any global variable and should not be used outside of the
coroutine. Envoy will fail your script if the handle is used incorrectly.</p>
</div>
<p>The following methods on the stream handle are supported:</p>
<section id="headers">
<h3><code class="docutils literal notranslate"><span class="pre">headers()</span></code><a class="headerlink" href="#headers" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">headers</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the stream’s headers. The headers can be modified as long as they have not been sent to
the next filter in the header chain. For example, they can be modified after an <em>httpCall()</em> or
after a <em>body()</em> call returns. The script will fail if the headers are modified in any other
situation.</p>
<p>Returns a <a class="reference internal" href="#config-http-filters-lua-header-wrapper"><span class="std std-ref">header object</span></a>.</p>
</section>
<section id="body">
<h3><code class="docutils literal notranslate"><span class="pre">body()</span></code><a class="headerlink" href="#body" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">body</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">body</span><span class="p">(</span><span class="n">always_wrap_body</span><span class="p">)</span>
</pre></div>
</div>
<p>Returns the stream’s body. This call will cause Envoy to suspend execution of the script until
the entire body has been received in a buffer. Note that all buffering must adhere to the
flow-control policies in place. Envoy will not buffer more data than is allowed by the connection
manager.</p>
<p>An optional boolean argument <code class="docutils literal notranslate"><span class="pre">always_wrap_body</span></code> can be used to require Envoy always returns a
<code class="docutils literal notranslate"><span class="pre">body</span></code> object even if the body is empty. Therefore we can modify the body regardless of whether the
original body exists or not.</p>
<p>Returns a <a class="reference internal" href="#config-http-filters-lua-buffer-wrapper"><span class="std std-ref">buffer object</span></a>.</p>
</section>
<section id="bodychunks">
<h3><code class="docutils literal notranslate"><span class="pre">bodyChunks()</span></code><a class="headerlink" href="#bodychunks" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">bodyChunks</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns an iterator that can be used to iterate through all received body chunks as they arrive.
Envoy will suspend executing the script in between chunks, but <em>will not buffer</em> them. This can be
used by a script to inspect data as it is streaming by.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">for</span> <span class="n">chunk</span> <span class="kr">in</span> <span class="n">request_handle</span><span class="p">:</span><span class="n">bodyChunks</span><span class="p">()</span> <span class="kr">do</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">log</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span><span class="n">length</span><span class="p">())</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>Each chunk the iterator returns is a <a class="reference internal" href="#config-http-filters-lua-buffer-wrapper"><span class="std std-ref">buffer object</span></a>.</p>
</section>
<section id="trailers">
<h3><code class="docutils literal notranslate"><span class="pre">trailers()</span></code><a class="headerlink" href="#trailers" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">trailers</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">trailers</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the stream’s trailers. Before calling this method, the caller should call <code class="docutils literal notranslate"><span class="pre">body()</span></code> or
<code class="docutils literal notranslate"><span class="pre">bodyChunks()</span></code> to consume the body, otherwise the trailers will not be available.
May return nil if there are no trailers. The trailers may be modified before they are sent
to the next filter.</p>
<p>Returns a <a class="reference internal" href="#config-http-filters-lua-header-wrapper"><span class="std std-ref">header object</span></a>.</p>
</section>
<section id="log">
<h3><code class="docutils literal notranslate"><span class="pre">log*()</span></code><a class="headerlink" href="#log" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">logTrace</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logDebug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logWarn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logErr</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logCritical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>Logs a message using Envoy’s application logging. <em>message</em> is a string to log.</p>
<p>These are supported on all objects that Envoy exposes to Lua.</p>
</section>
<section id="httpcall">
<h3><code class="docutils literal notranslate"><span class="pre">httpCall()</span></code><a class="headerlink" href="#httpcall" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">httpCall</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">)</span>

<span class="c1">-- Alternative function signature.</span>
<span class="kd">local</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">httpCall</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
<p>Makes an HTTP call to an upstream host. <em>cluster</em> is a string which maps to a configured cluster manager cluster. <em>headers</em>
is a table of key/value pairs to send (the value can be a string or table of strings). Note that
the <em>:method</em>, <em>:path</em>, and <em>:authority</em> headers must be set. <em>body</em> is an optional string of body
data to send. <em>timeout_ms</em> is an integer that specifies the call timeout in milliseconds.</p>
<p><em>asynchronous</em> is a boolean flag. If async is set to true, Envoy will make the HTTP request and continue,
regardless of the response success or failure. If this is set to false, or not set, Envoy will suspend executing the script
until the call completes or has an error.</p>
<p>Returns <em>headers</em> which is a table of response headers. Returns <em>body</em> which is the string response
body. May be nil if there is no body.</p>
<p>The alternative function signature allows caller to specify <em>options</em> as a table. Currently,
the supported keys are:</p>
<ul>
<li><p><em>asynchronous</em> is a boolean flag that controls the asynchronicity of the HTTP call.
It refers to the same <em>asynchronous</em> flag as the first function signature.</p></li>
<li><p><em>timeout_ms</em> is an integer that specifies the call timeout in milliseconds.
It refers to the same <em>timeout_ms</em> argument as the first function signature.</p></li>
<li><p><em>trace_sampled</em> is a boolean flag that decides whether the produced trace span will be sampled or not. If not provided, the sampling decision of the parent span is used.</p></li>
<li><p><em>return_duplicate_headers</em> is boolean flag that decides whether the repeated headers are allowed in response headers.
If the <em>return_duplicate_headers</em> is set to false (default), the returned <em>headers</em> is table with value type of string.
If the <em>return_duplicate_headers</em> is set to true, the returned <em>headers</em> is table with value type of string or value type
of table.</p></li>
<li><p><em>send_xff</em> is a boolean flag that decides whether the <em>x-forwarded-for</em> header is sent to target server.
The default value is true.</p>
<p>For example, the following upstream response headers have repeated headers.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{
  { &quot;:status&quot;, &quot;200&quot; },
  { &quot;foo&quot;, &quot;bar&quot; },
  { &quot;key&quot;, &quot;value_0&quot; },
  { &quot;key&quot;, &quot;value_1&quot; },
  { &quot;key&quot;, &quot;value_2&quot; },
}
</pre></div>
</div>
<p>Then if <em>return_duplicate_headers</em> is set to false, the returned headers will be:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="p">[</span><span class="s2">&quot;:status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;200&quot;</span><span class="p">,</span>
  <span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
  <span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;value_2&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If <em>return_duplicate_headers</em> is set to true, the returned <em>headers</em> will be:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="p">[</span><span class="s2">&quot;:status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;200&quot;</span><span class="p">,</span>
  <span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
  <span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;value_0&quot;</span><span class="p">,</span> <span class="s2">&quot;value_1&quot;</span><span class="p">,</span> <span class="s2">&quot;value_2&quot;</span> <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
<p>Some examples of specifying <em>options</em> are shown below:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Create a fire-and-forget HTTP call.</span>
<span class="kd">local</span> <span class="n">request_options</span> <span class="o">=</span> <span class="p">{[</span><span class="s2">&quot;asynchronous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">}</span>

<span class="c1">-- Create a synchronous HTTP call with 1000 ms timeout.</span>
<span class="kd">local</span> <span class="n">request_options</span> <span class="o">=</span> <span class="p">{[</span><span class="s2">&quot;timeout_ms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">}</span>

<span class="c1">-- Create a synchronous HTTP call, but do not sample the trace span.</span>
<span class="kd">local</span> <span class="n">request_options</span> <span class="o">=</span> <span class="p">{[</span><span class="s2">&quot;trace_sampled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">}</span>

<span class="c1">-- The same as above, but explicitly set the &quot;asynchronous&quot; flag to false.</span>
<span class="kd">local</span> <span class="n">request_options</span> <span class="o">=</span> <span class="p">{[</span><span class="s2">&quot;asynchronous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;trace_sampled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">}</span>

<span class="c1">-- The same as above, but with 1000 ms timeout.</span>
<span class="kd">local</span> <span class="n">request_options</span> <span class="o">=</span> <span class="p">{[</span><span class="s2">&quot;asynchronous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;trace_sampled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;timeout_ms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span> <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="respond">
<h3><code class="docutils literal notranslate"><span class="pre">respond()</span></code><a class="headerlink" href="#respond" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">respond</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
</pre></div>
</div>
<p>Respond immediately and do not continue further filter iteration. This call is <em>only valid in
the request flow</em>. Additionally, a response is only possible if the request headers have not yet been
passed to subsequent filters. Meaning, the following Lua code is invalid:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="kr">for</span> <span class="n">chunk</span> <span class="kr">in</span> <span class="n">request_handle</span><span class="p">:</span><span class="n">bodyChunks</span><span class="p">()</span> <span class="kr">do</span>
    <span class="n">request_handle</span><span class="p">:</span><span class="n">respond</span><span class="p">(</span>
      <span class="p">{[</span><span class="s2">&quot;:status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;100&quot;</span><span class="p">},</span>
      <span class="s2">&quot;nope&quot;</span><span class="p">)</span>
  <span class="kr">end</span>
<span class="kr">end</span>
</pre></div>
</div>
<p><em>headers</em> is a table of key/value pairs to send (the value can be a string or table of strings).
Note that the <em>:status</em> header must be set. <em>body</em> is a string and supplies the optional response
body. May be nil.</p>
</section>
<section id="metadata">
<h3><code class="docutils literal notranslate"><span class="pre">metadata()</span></code><a class="headerlink" href="#metadata" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">metadata</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the current route entry metadata. Note that the metadata should be specified
under the filter name i.e. <em>envoy.filters.http.lua</em>. Below is an example of a <em>metadata</em> in a
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-msg-config-route-v3-route"><span class="std std-ref">route entry</span></a>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">filter_metadata</span><span class="p">:</span>
<span class="w">    </span><span class="nt">envoy.filters.http.lua</span><span class="p">:</span>
<span class="w">      </span><span class="nt">foo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bar</span>
<span class="w">      </span><span class="nt">baz</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bad</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">baz</span>
</pre></div>
</div>
<p>Returns a <a class="reference internal" href="#config-http-filters-lua-metadata-wrapper"><span class="std std-ref">metadata object</span></a>.</p>
</section>
<section id="streaminfo">
<h3><code class="docutils literal notranslate"><span class="pre">streamInfo()</span></code><a class="headerlink" href="#streaminfo" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">streamInfo</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">streamInfo</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns <a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.33.11/envoy/stream_info/stream_info.h">information</a> related to the current request.</p>
<p>Returns a <a class="reference internal" href="#config-http-filters-lua-stream-info-wrapper"><span class="std std-ref">stream info object</span></a>.</p>
</section>
<section id="connection">
<h3><code class="docutils literal notranslate"><span class="pre">connection()</span></code><a class="headerlink" href="#connection" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">connection</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the current request’s underlying <a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.33.11/envoy/network/connection.h">connection</a>.</p>
<p>Returns a <a class="reference internal" href="#config-http-filters-lua-connection-wrapper"><span class="std std-ref">connection object</span></a>.</p>
</section>
<section id="connectionstreaminfo">
<h3><code class="docutils literal notranslate"><span class="pre">connectionStreamInfo()</span></code><a class="headerlink" href="#connectionstreaminfo" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">connectionStreamInfo</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">connectionStreamInfo</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns connection-level <a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.33.11/envoy/stream_info/stream_info.h">information</a> related to the current request.</p>
<p>Returns a connection-level <a class="reference internal" href="#config-http-filters-lua-cx-stream-info-wrapper"><span class="std std-ref">stream info object</span></a>.</p>
</section>
<section id="setupstreamoverridehost">
<h3><code class="docutils literal notranslate"><span class="pre">setUpstreamOverrideHost()</span></code><a class="headerlink" href="#setupstreamoverridehost" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">setUpstreamOverrideHost</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">strict</span><span class="p">)</span>
</pre></div>
</div>
<p>Sets an upstream address override for the request. When the overridden host is available and can be selected directly,
the load balancer bypasses its algorithm and routes traffic directly to the specified host. The strict flag determines
whether the HTTP request must strictly use the overridden destination. If the destination is unavailable and strict is
set to true, Envoy responds with a 503 Service Unavailable error.</p>
<p>The function takes two arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">host</span></code> (string): The upstream host address to use for the request. This must be a valid IP address; otherwise, the
Lua script will throw an error.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">strict</span></code> (boolean, optional): Determines whether the HTTP request must be strictly routed to the requested
destination. When set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, if the requested destination is unavailable, Envoy will return a 503 status code.
The default value is <code class="docutils literal notranslate"><span class="pre">false</span></code>, which allows Envoy to fall back to its load balancing mechanism. In this case, if the
requested destination is not found, the request will be routed according to the load balancing algorithm.</p></li>
</ul>
<p>Example:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="c1">-- Override upstream host without strict mode</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">setUpstreamOverrideHost</span><span class="p">(</span><span class="s2">&quot;192.168.21.13&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>

  <span class="c1">-- Override upstream host with strict mode</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">setUpstreamOverrideHost</span><span class="p">(</span><span class="s2">&quot;192.168.21.13&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
</section>
<section id="importpublickey">
<h3><code class="docutils literal notranslate"><span class="pre">importPublicKey()</span></code><a class="headerlink" href="#importpublickey" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">pubkey</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">importPublicKey</span><span class="p">(</span><span class="n">keyder</span><span class="p">,</span> <span class="n">keyderLength</span><span class="p">)</span>
</pre></div>
</div>
<p>Returns public key which is used by <a class="reference internal" href="#verify-signature"><span class="std std-ref">verifySignature</span></a> to verify digital signature.</p>
</section>
<section id="verifysignature">
<span id="verify-signature"></span><h3><code class="docutils literal notranslate"><span class="pre">verifySignature()</span></code><a class="headerlink" href="#verifysignature" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="nb">error</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">verifySignature</span><span class="p">(</span><span class="n">hashFunction</span><span class="p">,</span> <span class="n">pubkey</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">signatureLength</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataLength</span><span class="p">)</span>
</pre></div>
</div>
<p>Verify signature using provided parameters. <em>hashFunction</em> is the variable for the hash function which be used
for verifying signature. <em>SHA1</em>, <em>SHA224</em>, <em>SHA256</em>, <em>SHA384</em> and <em>SHA512</em> are supported.
<em>pubkey</em> is the public key. <em>signature</em> is the signature to be verified. <em>signatureLength</em> is
the length of the signature. <em>data</em> is the content which will be hashed. <em>dataLength</em> is the length of data.</p>
<p>The function returns a pair. If the first element is <em>true</em>, the second element will be empty
which means signature is verified; otherwise, the second element will store the error message.</p>
</section>
<section id="base64escape">
<span id="config-http-filters-lua-stream-handle-api-base64-escape"></span><h3><code class="docutils literal notranslate"><span class="pre">base64Escape()</span></code><a class="headerlink" href="#base64escape" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">base64_encoded</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">base64Escape</span><span class="p">(</span><span class="s2">&quot;input string&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Encodes the input string as base64. This can be useful for escaping binary data.</p>
</section>
<section id="timestamp">
<h3><code class="docutils literal notranslate"><span class="pre">timestamp()</span></code><a class="headerlink" href="#timestamp" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">timestamp</span><span class="p">(</span><span class="n">format</span><span class="p">)</span>
</pre></div>
</div>
<p>High resolution timestamp function. <em>format</em> is an optional enum parameter to indicate the format of the timestamp.
<em>EnvoyTimestampResolution.MILLISECOND</em> is supported
The function returns timestamp in milliseconds since epoch by default if format is not set.</p>
</section>
<section id="timestampstring">
<span id="config-http-filters-lua-stream-handle-api-timestamp-string"></span><h3><code class="docutils literal notranslate"><span class="pre">timestampString()</span></code><a class="headerlink" href="#timestampstring" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">timestampString</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
</pre></div>
</div>
<p>Timestamp function. Timestamp is returned as a string. It represents the integer value of the selected resolution
since epoch. <em>resolution</em> is an optional enum parameter to indicate the resolution of the timestamp.
Supported resolutions are <em>EnvoyTimestampResolution.MILLISECOND</em> and <em>EnvoyTimestampResolution.MICROSECOND</em>.
Default resolution is millisecond if <em>resolution</em> is not set.</p>
</section>
</section>
<section id="header-object-api">
<span id="config-http-filters-lua-header-wrapper"></span><h2>Header object API<a class="headerlink" href="#header-object-api" title="Link to this heading"></a></h2>
<section id="id2">
<h3><code class="docutils literal notranslate"><span class="pre">log*()</span></code><a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">logTrace</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logDebug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logWarn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logErr</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logCritical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>Logs a message using Envoy’s application logging. <em>message</em> is a string to log.</p>
<p>These are supported on all objects that Envoy exposes to Lua.</p>
</section>
<section id="add">
<h3><code class="docutils literal notranslate"><span class="pre">add()</span></code><a class="headerlink" href="#add" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">headers</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>Adds a header. <em>key</em> is a string that supplies the header key. <em>value</em> is a string that supplies
the header value.</p>
</section>
<section id="get">
<h3><code class="docutils literal notranslate"><span class="pre">get()</span></code><a class="headerlink" href="#get" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">headers</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>Gets a header. <em>key</em> is a string that supplies the header key. Returns a string that is the header
value or nil if there is no such header. If there are multiple headers in the same case-insensitive
key, their values will be combined with a <em>,</em> separator and returned as a string.</p>
</section>
<section id="getatindex">
<h3><code class="docutils literal notranslate"><span class="pre">getAtIndex()</span></code><a class="headerlink" href="#getatindex" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">headers</span><span class="p">:</span><span class="n">getAtIndex</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
<p>Gets the header value at the given index. It can be used to fetch a specific value in case the
given header has multiple values. <em>key</em> is a string that supplies the header key and index is
an integer that supplies the position. It returns a string that is the header value or nil if
there is no such header or if there is no value at the specified index.</p>
</section>
<section id="getnumvalues">
<h3><code class="docutils literal notranslate"><span class="pre">getNumValues()</span></code><a class="headerlink" href="#getnumvalues" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">headers</span><span class="p">:</span><span class="n">getNumValues</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>Gets the number of values of a given header. It can be used to fetch the total number of values in case
the given header has multiple values. <em>key</em> is a string that supplies the header key. It returns
an integer with the value size for the given header or <em>0</em> if there is no such header.</p>
</section>
<section id="pairs">
<h3><code class="docutils literal notranslate"><span class="pre">__pairs()</span></code><a class="headerlink" href="#pairs" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="kr">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span> <span class="kr">do</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>Iterates through every header. <em>key</em> is a string that supplies the header key. <em>value</em> is a string
that supplies the header value.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>In the current implementation, headers cannot be modified during iteration. Additionally, if
it is necessary to modify headers after an iteration, the iteration must first be completed. This means that
<code class="docutils literal notranslate"><span class="pre">break</span></code> or any other way to exit the loop early must not be used. This may be more flexible in the future.</p>
</div>
</section>
<section id="remove">
<h3><code class="docutils literal notranslate"><span class="pre">remove()</span></code><a class="headerlink" href="#remove" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">headers</span><span class="p">:</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>Removes a header. <em>key</em> supplies the header key to remove.</p>
</section>
<section id="replace">
<h3><code class="docutils literal notranslate"><span class="pre">replace()</span></code><a class="headerlink" href="#replace" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">headers</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>Replaces a header. <em>key</em> is a string that supplies the header key. <em>value</em> is a string that supplies
the header value. If the header does not exist, it is added as per the <em>add()</em> function.</p>
</section>
<section id="sethttp1reasonphrase">
<h3><code class="docutils literal notranslate"><span class="pre">setHttp1ReasonPhrase()</span></code><a class="headerlink" href="#sethttp1reasonphrase" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">headers</span><span class="p">:</span><span class="n">setHttp1ReasonPhrase</span><span class="p">(</span><span class="n">reasonPhrase</span><span class="p">)</span>
</pre></div>
</div>
<p>Sets a custom HTTP/1 response reason phrase. This call is <em>only valid in the response flow</em>.
<em>reasonPhrase</em> is a string that supplies the reason phrase value. Additionally this call only
effects HTTP/1 connections. It will have no effect if the client is HTTP/2 or HTTP/3.</p>
</section>
</section>
<section id="buffer-api">
<span id="config-http-filters-lua-buffer-wrapper"></span><h2>Buffer API<a class="headerlink" href="#buffer-api" title="Link to this heading"></a></h2>
<section id="id3">
<h3><code class="docutils literal notranslate"><span class="pre">log*()</span></code><a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">logTrace</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logDebug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logWarn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logErr</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logCritical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>Logs a message using Envoy’s application logging. <em>message</em> is a string to log.</p>
<p>These are supported on all objects that Envoy exposes to Lua.</p>
</section>
<section id="length">
<h3><code class="docutils literal notranslate"><span class="pre">length()</span></code><a class="headerlink" href="#length" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">size</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">:</span><span class="n">length</span><span class="p">()</span>
</pre></div>
</div>
<p>Gets the size of the buffer in bytes. Returns an integer.</p>
</section>
<section id="getbytes">
<h3><code class="docutils literal notranslate"><span class="pre">getBytes()</span></code><a class="headerlink" href="#getbytes" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">buffer</span><span class="p">:</span><span class="n">getBytes</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
</pre></div>
</div>
<p>Get bytes from the buffer. By default Envoy will not copy all buffer bytes to Lua. This will
cause a buffer segment to be copied. <em>index</em> is an integer and supplies the buffer start index to
copy. <em>length</em> is an integer and supplies the buffer length to copy. <em>index</em> + <em>length</em> must be
less than the buffer length.</p>
</section>
<section id="setbytes">
<span id="config-http-filters-lua-buffer-wrapper-api-set-bytes"></span><h3><code class="docutils literal notranslate"><span class="pre">setBytes()</span></code><a class="headerlink" href="#setbytes" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">buffer</span><span class="p">:</span><span class="n">setBytes</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</pre></div>
</div>
<p>Set the content of wrapped buffer with the input string.</p>
</section>
</section>
<section id="metadata-object-api">
<span id="config-http-filters-lua-metadata-wrapper"></span><h2>Metadata object API<a class="headerlink" href="#metadata-object-api" title="Link to this heading"></a></h2>
<section id="id4">
<h3><code class="docutils literal notranslate"><span class="pre">log*()</span></code><a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">logTrace</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logDebug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logWarn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logErr</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logCritical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>Logs a message using Envoy’s application logging. <em>message</em> is a string to log.</p>
<p>These are supported on all objects that Envoy exposes to Lua.</p>
</section>
<section id="id5">
<h3><code class="docutils literal notranslate"><span class="pre">get()</span></code><a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">metadata</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>Gets a metadata. <em>key</em> is a string that supplies the metadata key. Returns the corresponding
value of the given metadata key. The type of the value can be: <em>nil</em>, <em>boolean</em>, <em>number</em>,
<em>string</em> and <em>table</em>.</p>
</section>
<section id="id6">
<h3><code class="docutils literal notranslate"><span class="pre">__pairs()</span></code><a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="kr">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="kr">do</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>Iterates through every <em>metadata</em> entry. <em>key</em> is a string that supplies a <em>metadata</em>
key. <em>value</em> is a <em>metadata</em> entry value.</p>
</section>
</section>
<section id="stream-info-object-api">
<span id="config-http-filters-lua-stream-info-wrapper"></span><h2>Stream info object API<a class="headerlink" href="#stream-info-object-api" title="Link to this heading"></a></h2>
<section id="id7">
<h3><code class="docutils literal notranslate"><span class="pre">log*()</span></code><a class="headerlink" href="#id7" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">logTrace</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logDebug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logWarn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logErr</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logCritical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>Logs a message using Envoy’s application logging. <em>message</em> is a string to log.</p>
<p>These are supported on all objects that Envoy exposes to Lua.</p>
</section>
<section id="protocol">
<h3><code class="docutils literal notranslate"><span class="pre">protocol()</span></code><a class="headerlink" href="#protocol" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">streamInfo</span><span class="p">:</span><span class="n">protocol</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the string representation of <a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.33.11/envoy/http/protocol.h">HTTP protocol</a>
used by the current request. The possible values are: <code class="docutils literal notranslate"><span class="pre">HTTP/1.0</span></code>, <code class="docutils literal notranslate"><span class="pre">HTTP/1.1</span></code>, <code class="docutils literal notranslate"><span class="pre">HTTP/2</span></code> and <code class="docutils literal notranslate"><span class="pre">HTTP/3*</span></code>.</p>
</section>
<section id="routename">
<span id="config-http-filters-lua-stream-info-route-name"></span><h3><code class="docutils literal notranslate"><span class="pre">routeName()</span></code><a class="headerlink" href="#routename" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">streamInfo</span><span class="p">:</span><span class="n">routeName</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the name of the route matched by the filter chain. Returns an empty string if no route was matched.</p>
<p>Example usage:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">route_name</span> <span class="o">=</span> <span class="n">request_handle</span><span class="p">:</span><span class="n">streamInfo</span><span class="p">():</span><span class="n">routeName</span><span class="p">()</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="s2">&quot;Matched route: &quot;</span> <span class="o">..</span> <span class="n">route_name</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
</section>
<section id="downstreamdirectlocaladdress">
<span id="config-http-filters-lua-stream-info-downstream-direct-local-address"></span><h3><code class="docutils literal notranslate"><span class="pre">downstreamDirectLocalAddress()</span></code><a class="headerlink" href="#downstreamdirectlocaladdress" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">streamInfo</span><span class="p">:</span><span class="n">downstreamDirectLocalAddress</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the string representation of <a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.33.11/envoy/stream_info/stream_info.h">downstream direct local address</a>
used by the current request. This is always the physical local address of the connection.</p>
</section>
<section id="downstreamlocaladdress">
<h3><code class="docutils literal notranslate"><span class="pre">downstreamLocalAddress()</span></code><a class="headerlink" href="#downstreamlocaladdress" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">streamInfo</span><span class="p">:</span><span class="n">downstreamLocalAddress</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the string representation of <a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.33.11/envoy/stream_info/stream_info.h">downstream local address</a>
used by the current request.</p>
</section>
<section id="downstreamdirectremoteaddress">
<span id="config-http-filters-lua-stream-info-downstream-direct-remote-address"></span><h3><code class="docutils literal notranslate"><span class="pre">downstreamDirectRemoteAddress()</span></code><a class="headerlink" href="#downstreamdirectremoteaddress" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">streamInfo</span><span class="p">:</span><span class="n">downstreamDirectRemoteAddress</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the string representation of <a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.33.11/envoy/stream_info/stream_info.h">downstream directly connected address</a>
used by the current request. This is equivalent to the address of the physical connection.</p>
</section>
<section id="downstreamremoteaddress">
<span id="config-http-filters-lua-stream-info-downstream-remote-address"></span><h3><code class="docutils literal notranslate"><span class="pre">downstreamRemoteAddress()</span></code><a class="headerlink" href="#downstreamremoteaddress" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">streamInfo</span><span class="p">:</span><span class="n">downstreamRemoteAddress</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the string representation of the downstream remote address for the current request. This may differ from
<a class="reference internal" href="#config-http-filters-lua-stream-info-downstream-direct-remote-address"><span class="std std-ref">downstreamDirectRemoteAddress()</span></a> depending upon the setting of
<a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-xff-num-trusted-hops"><span class="std std-ref">xff_num_trusted_hops</span></a>.</p>
</section>
<section id="dynamicmetadata">
<h3><code class="docutils literal notranslate"><span class="pre">dynamicMetadata()</span></code><a class="headerlink" href="#dynamicmetadata" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">streamInfo</span><span class="p">:</span><span class="n">dynamicMetadata</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns a <a class="reference internal" href="#config-http-filters-lua-stream-info-dynamic-metadata-wrapper"><span class="std std-ref">dynamic metadata object</span></a>.</p>
</section>
<section id="downstreamsslconnection">
<h3><code class="docutils literal notranslate"><span class="pre">downstreamSslConnection()</span></code><a class="headerlink" href="#downstreamsslconnection" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">streamInfo</span><span class="p">:</span><span class="n">downstreamSslConnection</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns <a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.33.11/envoy/ssl/connection.h">information</a> related to the current SSL connection.</p>
<p>Returns a downstream <a class="reference internal" href="#config-http-filters-lua-ssl-socket-info"><span class="std std-ref">SSL connection info object</span></a>.</p>
</section>
<section id="requestedservername">
<span id="config-http-filters-lua-stream-info-dynamic-metadata-wrapper"></span><h3><code class="docutils literal notranslate"><span class="pre">requestedServerName()</span></code><a class="headerlink" href="#requestedservername" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">streamInfo</span><span class="p">:</span><span class="n">requestedServerName</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the string representation of <a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.33.11/envoy/stream_info/stream_info.h">requested server name</a>
(e.g. SNI in TLS) for the current request if present.</p>
</section>
</section>
<section id="connection-stream-info-object-api">
<span id="config-http-filters-lua-cx-stream-info-wrapper"></span><h2>Connection stream info object API<a class="headerlink" href="#connection-stream-info-object-api" title="Link to this heading"></a></h2>
<section id="id8">
<h3><code class="docutils literal notranslate"><span class="pre">log*()</span></code><a class="headerlink" href="#id8" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">logTrace</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logDebug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logWarn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logErr</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logCritical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>Logs a message using Envoy’s application logging. <em>message</em> is a string to log.</p>
<p>These are supported on all objects that Envoy exposes to Lua.</p>
</section>
<section id="id9">
<h3><code class="docutils literal notranslate"><span class="pre">dynamicMetadata()</span></code><a class="headerlink" href="#id9" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">connectionStreamInfo</span><span class="p">:</span><span class="n">dynamicMetadata</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns a <a class="reference internal" href="#config-http-filters-lua-stream-info-dynamic-metadata-wrapper"><span class="std std-ref">dynamic metadata object</span></a>.</p>
</section>
</section>
<section id="dynamic-metadata-object-api">
<h2>Dynamic metadata object API<a class="headerlink" href="#dynamic-metadata-object-api" title="Link to this heading"></a></h2>
<section id="id10">
<h3><code class="docutils literal notranslate"><span class="pre">log*()</span></code><a class="headerlink" href="#id10" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">logTrace</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logDebug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logWarn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logErr</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logCritical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>Logs a message using Envoy’s application logging. <em>message</em> is a string to log.</p>
<p>These are supported on all objects that Envoy exposes to Lua.</p>
</section>
<section id="id11">
<h3><code class="docutils literal notranslate"><span class="pre">get()</span></code><a class="headerlink" href="#id11" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">dynamicMetadata</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">filterName</span><span class="p">)</span>

<span class="c1">-- to get a value from a returned table.</span>
<span class="n">dynamicMetadata</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">filterName</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span>
</pre></div>
</div>
<p>Gets an entry in dynamic metadata struct. <em>filterName</em> is a string that supplies the filter name, e.g. <em>envoy.lb</em>.
Returns the corresponding <em>table</em> of a given <em>filterName</em>.</p>
</section>
<section id="set">
<h3><code class="docutils literal notranslate"><span class="pre">set()</span></code><a class="headerlink" href="#set" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">dynamicMetadata</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="n">filterName</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>Sets key-value pair of a <em>filterName</em>’s metadata. <em>filterName</em> is a key specifying the target filter name,
e.g. <em>envoy.lb</em>. The type of <em>key</em> is <em>string</em>. The type of <em>value</em> is any Lua type that can be mapped
to a metadata value: <em>table</em>, <em>numeric</em>, <em>boolean</em>, <em>string</em> or <em>nil</em>. When using a <em>table</em> as an argument,
its keys can only be <em>string</em> or <em>numeric</em>.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">()</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">streamInfo</span><span class="p">():</span><span class="n">dynamicMetadata</span><span class="p">():</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;envoy.filters.http.lua&quot;</span><span class="p">,</span> <span class="s2">&quot;request.info&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">headers</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;authorization&quot;</span><span class="p">),</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">headers</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x-request-token&quot;</span><span class="p">),</span>
  <span class="p">})</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">envoy_on_response</span><span class="p">(</span><span class="n">response_handle</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">response_handle</span><span class="p">:</span><span class="n">streamInfo</span><span class="p">():</span><span class="n">dynamicMetadata</span><span class="p">():</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;envoy.filters.http.lua&quot;</span><span class="p">)[</span><span class="s2">&quot;request.info&quot;</span><span class="p">]</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="s2">&quot;Auth: &quot;</span><span class="o">..</span><span class="n">meta</span><span class="p">.</span><span class="n">auth</span><span class="o">..</span><span class="s2">&quot;, token: &quot;</span><span class="o">..</span><span class="n">meta</span><span class="p">.</span><span class="n">token</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
</section>
<section id="id12">
<h3><code class="docutils literal notranslate"><span class="pre">__pairs()</span></code><a class="headerlink" href="#id12" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="kr">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">dynamicMetadata</span><span class="p">)</span> <span class="kr">do</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>Iterates through every <em>dynamicMetadata</em> entry. <em>key</em> is a string that supplies a <em>dynamicMetadata</em>
key. <em>value</em> is a <em>dynamicMetadata</em> entry value.</p>
</section>
</section>
<section id="connection-object-api">
<span id="config-http-filters-lua-connection-wrapper"></span><h2>Connection object API<a class="headerlink" href="#connection-object-api" title="Link to this heading"></a></h2>
<section id="id13">
<h3><code class="docutils literal notranslate"><span class="pre">log*()</span></code><a class="headerlink" href="#id13" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">logTrace</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logDebug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logWarn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logErr</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logCritical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>Logs a message using Envoy’s application logging. <em>message</em> is a string to log.</p>
<p>These are supported on all objects that Envoy exposes to Lua.</p>
</section>
<section id="ssl">
<h3><code class="docutils literal notranslate"><span class="pre">ssl()</span></code><a class="headerlink" href="#ssl" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">if</span> <span class="n">connection</span><span class="p">:</span><span class="n">ssl</span><span class="p">()</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">)</span>
<span class="kr">else</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;secure&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>Returns <a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.33.11/envoy/ssl/connection.h">SSL connection</a> object when the connection is
secured and <em>nil</em> when it is not.</p>
<p>Returns an <a class="reference internal" href="#config-http-filters-lua-ssl-socket-info"><span class="std std-ref">SSL connection info object</span></a>.</p>
</section>
</section>
<section id="ssl-connection-object-api">
<span id="config-http-filters-lua-ssl-socket-info"></span><h2>SSL connection object API<a class="headerlink" href="#ssl-connection-object-api" title="Link to this heading"></a></h2>
<section id="id14">
<h3><code class="docutils literal notranslate"><span class="pre">log*()</span></code><a class="headerlink" href="#id14" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">logTrace</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logDebug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logWarn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logErr</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logCritical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>Logs a message using Envoy’s application logging. <em>message</em> is a string to log.</p>
<p>These are supported on all objects that Envoy exposes to Lua.</p>
</section>
<section id="peercertificatepresented">
<h3><code class="docutils literal notranslate"><span class="pre">peerCertificatePresented()</span></code><a class="headerlink" href="#peercertificatepresented" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">if</span> <span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">peerCertificatePresented</span><span class="p">()</span> <span class="kr">then</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;peer certificate is presented&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>Returns a bool representing whether the peer certificate is presented.</p>
</section>
<section id="peercertificatevalidated">
<h3><code class="docutils literal notranslate"><span class="pre">peerCertificateValidated()</span></code><a class="headerlink" href="#peercertificatevalidated" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">if</span> <span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">peerCertificateValidated</span><span class="p">()</span> <span class="kr">then</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;peer certificate is validated&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>Returns bool whether the peer certificate was validated.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Client certificate validation is not currently performed upon TLS session resumption. For a
resumed TLS session this method will return false, regardless of whether the peer certificate is
valid.</p>
<p>The only known workaround for this issue is to disable TLS session resumption entirely, by
setting both <a class="reference internal" href="../../../api-v3/extensions/transport_sockets/tls/v3/tls.proto.html#envoy-v3-api-field-extensions-transport-sockets-tls-v3-downstreamtlscontext-disable-stateless-session-resumption"><span class="std std-ref">disable_stateless_session_resumption</span></a>
and <a class="reference internal" href="../../../api-v3/extensions/transport_sockets/tls/v3/tls.proto.html#envoy-v3-api-field-extensions-transport-sockets-tls-v3-downstreamtlscontext-disable-stateful-session-resumption"><span class="std std-ref">disable_stateful_session_resumption</span></a> on the DownstreamTlsContext.</p>
</div>
</section>
<section id="urisanlocalcertificate">
<h3><code class="docutils literal notranslate"><span class="pre">uriSanLocalCertificate()</span></code><a class="headerlink" href="#urisanlocalcertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">-- For example, uriSanLocalCertificate contains {&quot;san1&quot;, &quot;san2&quot;}</span>
<span class="kd">local</span> <span class="n">certs</span> <span class="o">=</span> <span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">uriSanLocalCertificate</span><span class="p">()</span>

<span class="c1">-- The following prints san1,san2</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logTrace</span><span class="p">(</span><span class="nb">table.concat</span><span class="p">(</span><span class="n">certs</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>Returns the URIs (as a table) in the SAN field of the local certificate. Returns an empty table if
there is no local certificate, or no SAN field, or no URI SAN entries.</p>
</section>
<section id="sha256peercertificatedigest">
<h3><code class="docutils literal notranslate"><span class="pre">sha256PeerCertificateDigest()</span></code><a class="headerlink" href="#sha256peercertificatedigest" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">sha256PeerCertificateDigest</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the SHA256 digest of the peer certificate. Returns <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> if there is no peer certificate
which can happen in TLS (non-mTLS) connections.</p>
</section>
<section id="serialnumberpeercertificate">
<h3><code class="docutils literal notranslate"><span class="pre">serialNumberPeerCertificate()</span></code><a class="headerlink" href="#serialnumberpeercertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">serialNumberPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the serial number field of the peer certificate. Returns <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> if there is no peer
certificate, or no serial number.</p>
</section>
<section id="issuerpeercertificate">
<h3><code class="docutils literal notranslate"><span class="pre">issuerPeerCertificate()</span></code><a class="headerlink" href="#issuerpeercertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">issuerPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the issuer field of the peer certificate in RFC 2253 format. Returns <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> if there is no
peer certificate, or no issuer.</p>
</section>
<section id="subjectpeercertificate">
<h3><code class="docutils literal notranslate"><span class="pre">subjectPeerCertificate()</span></code><a class="headerlink" href="#subjectpeercertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">subjectPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>Return the subject field of the peer certificate in RFC 2253 format. Returns <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> if there is no
peer certificate, or no subject.</p>
</section>
<section id="parsedsubjectpeercertificate">
<h3><code class="docutils literal notranslate"><span class="pre">parsedSubjectPeerCertificate()</span></code><a class="headerlink" href="#parsedsubjectpeercertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">parsedSubject</span> <span class="o">=</span> <span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">parsedSubjectPeerCertificate</span><span class="p">()</span>
<span class="kr">if</span> <span class="n">parsedSubject</span> <span class="kr">then</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CN: &quot;</span> <span class="o">..</span> <span class="n">parsedSubject</span><span class="p">:</span><span class="n">commonName</span><span class="p">())</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;O: &quot;</span> <span class="o">..</span> <span class="nb">table.concat</span><span class="p">(</span><span class="n">parsedSubject</span><span class="p">:</span><span class="n">organizationName</span><span class="p">(),</span> <span class="s2">&quot;,&quot;</span><span class="p">))</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>Returns <a class="extlink-repo reference external" href="https://github.com/envoyproxy/envoy/blob/v1.33.11/envoy/ssl/parsed_x509_name.h">connection</a> parsed from subject field of the peer
certificate. Returns nil if there is no peer certificate.</p>
<p>Returns a <a class="reference internal" href="#config-http-filters-lua-parsed-name"><span class="std std-ref">parsed name object</span></a>.</p>
</section>
<section id="urisanpeercertificate">
<h3><code class="docutils literal notranslate"><span class="pre">uriSanPeerCertificate()</span></code><a class="headerlink" href="#urisanpeercertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">uriSanPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the URIs (as a table) in the SAN field of the peer certificate. Returns an empty table if
there is no peer certificate, or no SAN field, or no URI SAN entries.</p>
</section>
<section id="subjectlocalcertificate">
<h3><code class="docutils literal notranslate"><span class="pre">subjectLocalCertificate()</span></code><a class="headerlink" href="#subjectlocalcertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">subjectLocalCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the subject field of the local certificate in RFC 2253 format. Returns <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> if there is no
local certificate, or no subject.</p>
</section>
<section id="urlencodedpemencodedpeercertificate">
<h3><code class="docutils literal notranslate"><span class="pre">urlEncodedPemEncodedPeerCertificate()</span></code><a class="headerlink" href="#urlencodedpemencodedpeercertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">urlEncodedPemEncodedPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the URL-encoded PEM-encoded representation of the peer certificate. Returns <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> if there
is no peer certificate or encoding fails.</p>
</section>
<section id="urlencodedpemencodedpeercertificatechain">
<h3><code class="docutils literal notranslate"><span class="pre">urlEncodedPemEncodedPeerCertificateChain()</span></code><a class="headerlink" href="#urlencodedpemencodedpeercertificatechain" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">urlEncodedPemEncodedPeerCertificateChain</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the URL-encoded PEM-encoded representation of the full peer certificate chain including the
leaf certificate. Returns <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> if there is no peer certificate or encoding fails.</p>
</section>
<section id="dnssanspeercertificate">
<h3><code class="docutils literal notranslate"><span class="pre">dnsSansPeerCertificate()</span></code><a class="headerlink" href="#dnssanspeercertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">dnsSansPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the DNS entries (as a table) in the SAN field of the peer certificate. Returns an empty
table if there is no peer certificate, or no SAN field, or no DNS SAN entries.</p>
</section>
<section id="dnssanslocalcertificate">
<h3><code class="docutils literal notranslate"><span class="pre">dnsSansLocalCertificate()</span></code><a class="headerlink" href="#dnssanslocalcertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">dnsSansLocalCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the DNS entries (as a table) in the SAN field of the local certificate. Returns an empty
table if there is no local certificate, or no SAN field, or no DNS SAN entries.</p>
</section>
<section id="oidspeercertificate">
<h3><code class="docutils literal notranslate"><span class="pre">oidsPeerCertificate()</span></code><a class="headerlink" href="#oidspeercertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">oidsPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the string representation of OIDs (as a table) from the peer certificate. This is for
reading the OID strings from the certificate, not the extension values associated with OIDs.
Returns an empty table if there is no peer certificate or no OIDs.</p>
</section>
<section id="oidslocalcertificate">
<h3><code class="docutils literal notranslate"><span class="pre">oidsLocalCertificate()</span></code><a class="headerlink" href="#oidslocalcertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">oidsLocalCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the string representation of OIDs (as a table) from the local certificate. This is for
reading the OID strings from the certificate, not the extension values associated with OIDs.
Returns an empty table if there is no local certificate or no OIDs.</p>
</section>
<section id="validfrompeercertificate">
<h3><code class="docutils literal notranslate"><span class="pre">validFromPeerCertificate()</span></code><a class="headerlink" href="#validfrompeercertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">validFromPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the time (timestamp-since-epoch in seconds) that the peer certificate was issued and should
be considered valid from. Returns <code class="docutils literal notranslate"><span class="pre">0</span></code> if there is no peer certificate.</p>
<p>In Lua, we usually use <code class="docutils literal notranslate"><span class="pre">os.time(os.date(&quot;!*t&quot;))</span></code> to get current timestamp-since-epoch in seconds.</p>
</section>
<section id="expirationpeercertificate">
<h3><code class="docutils literal notranslate"><span class="pre">expirationPeerCertificate()</span></code><a class="headerlink" href="#expirationpeercertificate" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">validFromPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the time (timestamp-since-epoch in seconds) that the peer certificate expires and should not
be considered valid after. Returns <code class="docutils literal notranslate"><span class="pre">0</span></code> if there is no peer certificate.</p>
<p>In Lua, we usually use <code class="docutils literal notranslate"><span class="pre">os.time(os.date(&quot;!*t&quot;))</span></code> to get current timestamp-since-epoch in seconds.</p>
</section>
<section id="sessionid">
<h3><code class="docutils literal notranslate"><span class="pre">sessionId()</span></code><a class="headerlink" href="#sessionid" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">sessionId</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the hex-encoded TLS session ID as defined in RFC 5246.</p>
</section>
<section id="ciphersuiteid">
<h3><code class="docutils literal notranslate"><span class="pre">ciphersuiteId()</span></code><a class="headerlink" href="#ciphersuiteid" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">ciphersuiteId</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the standard ID (hex-encoded) for the ciphers used in the established TLS connection.
Returns <code class="docutils literal notranslate"><span class="pre">&quot;0xffff&quot;</span></code> if there is no current negotiated ciphersuite.</p>
</section>
<section id="ciphersuitestring">
<h3><code class="docutils literal notranslate"><span class="pre">ciphersuiteString()</span></code><a class="headerlink" href="#ciphersuitestring" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">ciphersuiteString</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the OpenSSL name for the set of ciphers used in the established TLS connection. Returns
<code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> if there is no current negotiated ciphersuite.</p>
</section>
<section id="tlsversion">
<h3><code class="docutils literal notranslate"><span class="pre">tlsVersion()</span></code><a class="headerlink" href="#tlsversion" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">tlsVersion</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the TLS version (e.g., TLSv1.2, TLSv1.3) used in the established TLS connection.</p>
</section>
</section>
<section id="parsed-name-object-api">
<span id="config-http-filters-lua-parsed-name"></span><h2>Parsed name object API<a class="headerlink" href="#parsed-name-object-api" title="Link to this heading"></a></h2>
<section id="id15">
<h3><code class="docutils literal notranslate"><span class="pre">log*()</span></code><a class="headerlink" href="#id15" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">logTrace</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logDebug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logWarn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logErr</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logCritical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>Logs a message using Envoy’s application logging. <em>message</em> is a string to log.</p>
<p>These are supported on all objects that Envoy exposes to Lua.</p>
</section>
<section id="commonname">
<h3><code class="docutils literal notranslate"><span class="pre">commonName()</span></code><a class="headerlink" href="#commonname" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">parsedSubject</span><span class="p">:</span><span class="n">commonName</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the string representation of CN field from the X.509 name. Returns <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> if there is no such
field or if the field can’t be converted to UTF8 string.</p>
</section>
<section id="organizationname">
<h3><code class="docutils literal notranslate"><span class="pre">organizationName()</span></code><a class="headerlink" href="#organizationname" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">parsedSubject</span><span class="p">:</span><span class="n">organizationName</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns the string representation of O fields (as a table) from the X.509 name. Returns an empty
table if there is no such field or if the field can’t be converted to UTF8 string.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="local_rate_limit_filter.html" class="btn btn-neutral float-left" title="Local rate limit" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="oauth2_filter.html" class="btn btn-neutral float-right" title="OAuth2" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2025, Envoy Project Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>